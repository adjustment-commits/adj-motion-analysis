<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kinetic Chain Analyzer Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <style>
    body { font-family: 'Avenir', sans-serif; background: #050505; color: #fff; margin: 0; }
    #ui-overlay { position: absolute; top: 10px; left: 10px; z-index: 10; pointer-events: none; }
    .status-badge { background: rgba(0,0,0,0.7); padding: 10px; border-left: 4px solid #00ffcc; margin-bottom: 5px; }
    canvas { width: 100vw; height: 100vh; object-fit: contain; }
    .controls { position: fixed; bottom: 20px; width: 100%; display: flex; justify-content: center; gap: 10px; }
    label, button { background: #222; border: 1px solid #444; color: white; padding: 12px 20px; border-radius: 30px; cursor: pointer; }
    #fc-flash { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; opacity:0; transition: 0.2s; background: white; }
  </style>
</head>
<body>

<div id="fc-flash"></div>
<div id="ui-overlay">
  <div class="status-badge" id="fc-status">æ¥åœ°å¾…æ©Ÿä¸­...</div>
  <div class="status-badge" id="girdle-status">è‚©ç”²å¸¯ï¼šç‹¬ç«‹æ€§ãƒã‚§ãƒƒã‚¯</div>
  <div class="status-badge" id="arm-status">è…•ï¼šæ—‹å›ãƒã‚§ãƒƒã‚¯</div>
</div>

<canvas id="output_canvas"></canvas>
<video id="input_video" playsinline muted style="display:none;"></video>

<div class="controls">
  <label for="upload">ğŸ“¹ åˆ†æå‹•ç”»ã‚’é¸æŠ
    <input type="file" id="upload" accept="video/*" style="display:none">
  </label>
  <button onclick="videoElement.playbackRate = 0.2">è¶…ã‚¹ãƒ­ãƒ¼</button>
  <button onclick="videoElement.paused ? videoElement.play() : videoElement.pause()">å†ç”Ÿ/åœæ­¢</button>
</div>

<script>
  const videoElement = document.getElementById('input_video');
  const canvasElement = document.getElementById('output_canvas');
  const canvasCtx = canvasElement.getContext('2d');
  const flash = document.getElementById('fc-flash');

  let footContacted = false;
  let prevAnkleY = 0;

  const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
  pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.6 });

  pose.onResults((results) => {
    if (!results.poseLandmarks) return;
    canvasElement.width = results.image.width;
    canvasElement.height = results.image.height;
    canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

    const lm = results.poseLandmarks;
    const lSh = lm[11], rSh = lm[12], lHip = lm[23], rHip = lm[24];
    const lAnkle = lm[27], lKnee = lm[25], lWrist = lm[15], lElbow = lm[13];

    // 1. ãƒ•ãƒƒãƒˆã‚³ãƒ³ã‚¿ã‚¯ãƒˆ(FC)æ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼šè¶³é¦–ãŒæ­¢ã¾ã£ãŸç¬é–“ï¼‰
    if (!footContacted && lAnkle.y > 0.8 && Math.abs(lAnkle.y - prevAnkleY) < 0.001) {
      footContacted = true;
      flash.style.opacity = 0.5; setTimeout(() => flash.style.opacity = 0, 200);
      document.getElementById('fc-status').innerHTML = "âš½ æ¥åœ°ï¼(FOOT CONTACT)";
      document.getElementById('fc-status').style.borderLeftColor = "#ff3366";
    }
    prevAnkleY = lAnkle.y;

    // 2. èƒ¸éƒ­ vs è‚©ç”²å¸¯ ã®ç‹¬ç«‹æ€§ï¼ˆæ»è»¢å·®ï¼‰
    const torsoAngle = Math.atan2(lHip.y - lSh.y, lHip.x - lSh.x);
    const shoulderAngle = Math.atan2(rSh.y - lSh.y, rSh.x - lSh.x);
    const separation = Math.abs(torsoAngle - shoulderAngle);
    
    // è‚©ç”²å¸¯ã®ãƒ©ã‚¤ãƒ³æç”»
    canvasCtx.beginPath();
    canvasCtx.moveTo(lSh.x * canvasElement.width, lSh.y * canvasElement.height);
    canvasCtx.lineTo(rSh.x * canvasElement.width, rSh.y * canvasElement.height);
    // ç‹¬ç«‹ã—ã¦ã„ã‚Œã°é’ã€ä¸€ç·’ã«å›ã‚Œã°èµ¤
    const girdleColor = separation > 1.4 ? "#00ffff" : "#ff4444"; 
    canvasCtx.strokeStyle = girdleColor;
    canvasCtx.lineWidth = 10;
    canvasCtx.stroke();
    document.getElementById('girdle-status').style.color = girdleColor;
    document.getElementById('girdle-status').innerText = separation > 1.4 ? "è‚©ç”²å¸¯ï¼šç‹¬ç«‹ï¼ˆã‚¿ãƒ¡â—ï¼‰" : "è‚©ç”²å¸¯ï¼šé€£å‹•ï¼ˆæ‰‹æ‰“ã¡æ³¨æ„ï¼‰";

    // 3. è…•ã®å¤–æ—‹ãƒ»å†…æ—‹ï¼ˆè‚˜ã®è§’åº¦ã¨ä½ç½®é–¢ä¿‚ï¼‰
    const isExternal = lWrist.x < lElbow.x; // ç°¡æ˜“åˆ¤å®šï¼šæ‰‹é¦–ãŒè‚˜ã‚ˆã‚Šå¾Œã‚ã«ã‚ã‚Œã°å¤–æ—‹ï¼ˆã—ãªã‚Šï¼‰
    const armColor = isExternal ? "#ffff00" : "#ff00ff";
    drawConnectors(canvasCtx, [lSh, lElbow, lWrist], [[0,1],[1,2]], {color: armColor, lineWidth: 6});
    document.getElementById('arm-status').innerText = isExternal ? "è…•ï¼šå¤–æ—‹ï¼ˆã—ãªã‚Šä¸­ï¼‰" : "è…•ï¼šå†…æ—‹ï¼ˆãƒªãƒªãƒ¼ã‚¹ï¼‰";
    document.getElementById('arm-status').style.color = armColor;

    // éª¨æ ¼å…¨ä½“ã‚’è–„ãæç”»
    drawConnectors(canvasCtx, lm, POSE_CONNECTIONS, {color: 'rgba(255,255,255,0.2)', lineWidth: 1});
  });

  document.getElementById('upload').addEventListener('change', (e) => {
    footContacted = false;
    videoElement.src = URL.createObjectURL(e.target.files[0]);
    videoElement.play();
    const process = async () => {
      if (!videoElement.paused) { await pose.send({image: videoElement}); }
      requestAnimationFrame(process);
    };
    process();
  });
</script>
</body>
</html>
