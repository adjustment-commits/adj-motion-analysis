<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kinetic Chain Fix - Display OK</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <style>
    body { font-family: sans-serif; background: #000; color: #fff; margin: 0; text-align: center; }
    .main-view { position: relative; width: 100vw; height: 70vh; background: #111; display: flex; justify-content: center; align-items: center; }
    canvas { max-width: 100%; max-height: 100%; border: 1px solid #333; }
    .controls { padding: 20px; background: #222; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    label, button { background: #444; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; }
    .status-panel { padding: 10px; font-size: 1.2rem; color: #00ffcc; font-weight: bold; }
    input[type="checkbox"] { transform: scale(1.5); margin-right: 10px; }
  </style>
</head>
<body>

<div class="status-panel" id="info">å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</div>

<div class="main-view">
  <video id="input_video" playsinline muted style="display:none;"></video>
  <canvas id="output_canvas"></canvas>
</div>

<div class="controls">
  <label for="upload">ğŸ“¹ å‹•ç”»ã‚’é¸æŠ
    <input type="file" id="upload" accept="video/*" style="display:none">
  </label>
  
  <div style="background:#333; padding:10px; border-radius:8px;">
    <input type="checkbox" id="stick_only">
    <span>ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®ã¿è¡¨ç¤º</span>
  </div>

  <button onclick="playVideo()">å†ç”Ÿ/ä¸€æ™‚åœæ­¢</button>
  <button onclick="videoElement.playbackRate = 0.2">ã‚¹ãƒ­ãƒ¼(0.2x)</button>
</div>

<script>
  const videoElement = document.getElementById('input_video');
  const canvasElement = document.getElementById('output_canvas');
  const canvasCtx = canvasElement.getContext('2d');
  const stickOnlyCheck = document.getElementById('stick_only');
  const info = document.getElementById('info');

  const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
  pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5 });

  // è§£æçµæœãŒå‡ºãŸæ™‚ã®æç”»å‡¦ç†
  pose.onResults((results) => {
    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’å‹•ç”»ã«åˆã‚ã›ã‚‹
    canvasElement.width = results.image.width;
    canvasElement.height = results.image.height;

    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

    // 1. å‹•ç”»ã‚’è¡¨ç¤ºã™ã‚‹ã‹ã€çœŸã£é»’ã«ã™ã‚‹ã‹
    if (stickOnlyCheck.checked) {
      canvasCtx.fillStyle = "#000";
      canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);
    } else {
      canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
    }

    // 2. éª¨æ ¼ï¼ˆã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼‰ã®æç”»
    if (results.poseLandmarks) {
      const lm = results.poseLandmarks;
      
      // åŸºæœ¬ã®ç·š
      drawConnectors(canvasCtx, lm, POSE_CONNECTIONS, {color: 'rgba(255,255,255,0.5)', lineWidth: 2});

      // è‚©ç”²å¸¯ï¼ˆ11-12ï¼‰ã‚’å¼·èª¿
      const lSh = lm[11], rSh = lm[12];
      canvasCtx.beginPath();
      canvasCtx.moveTo(lSh.x * canvasElement.width, lSh.y * canvasElement.height);
      canvasCtx.lineTo(rSh.x * canvasElement.width, rSh.y * canvasElement.height);
      canvasCtx.strokeStyle = "#00ffcc";
      canvasCtx.lineWidth = 8;
      canvasCtx.stroke();
      
      info.innerText = "è§£æä¸­...";
    }
    canvasCtx.restore();
  });

  // å‹•ç”»èª­ã¿è¾¼ã¿å‡¦ç†
  document.getElementById('upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    info.innerText = "èª­ã¿è¾¼ã¿ä¸­...";
    const url = URL.createObjectURL(file);
    videoElement.src = url;
    
    // å‹•ç”»ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰è§£æãƒ«ãƒ¼ãƒ—é–‹å§‹
    videoElement.onloadedmetadata = () => {
      videoElement.play();
      requestAnimationFrame(renderLoop);
    };
  });

  async function renderLoop() {
    if (!videoElement.paused && !videoElement.ended) {
      await pose.send({image: videoElement});
    }
    requestAnimationFrame(renderLoop);
  }

  function playVideo() {
    if (videoElement.paused) {
      videoElement.play();
    } else {
      videoElement.pause();
    }
  }
</script>
</body>
</html>
