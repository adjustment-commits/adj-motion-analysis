<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kinetic Chain - Auto Impact Capture</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <style>
    body { font-family: sans-serif; background: #000; color: #fff; margin: 0; text-align: center; overflow: hidden; }
    .main-view { position: relative; width: 100vw; height: 65vh; background: #000; }
    canvas { max-width: 100%; max-height: 100%; }
    .ui-panel { height: 35vh; background: #1a1a1a; padding: 15px; box-sizing: border-box; }
    .score-display { display: flex; justify-content: space-around; margin-bottom: 15px; }
    .score-box { border-left: 4px solid #00ffcc; padding: 5px 15px; text-align: left; }
    .score-label { font-size: 12px; color: #aaa; }
    .score-value { font-size: 24px; font-weight: bold; color: #00ffcc; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    button, label { background: #333; color: white; border: 1px solid #555; padding: 12px 18px; border-radius: 8px; cursor: pointer; font-size: 14px; }
    button:active { background: #00ffcc; color: #000; }
    #download-link { display: none; }
  </style>
</head>
<body>

<div class="main-view">
  <video id="input_video" playsinline muted style="display:none;"></video>
  <canvas id="output_canvas"></canvas>
</div>

<div class="ui-panel">
  <div class="score-display">
    <div class="score-box">
      <div class="score-label">ç¾åœ¨ã®æ»è»¢å·®</div>
      <div class="score-value" id="current-sep">0.0Â°</div>
    </div>
    <div class="score-box" style="border-left-color: #ffcc00;">
      <div class="score-label">MAXã‚¿ãƒ¡(ç‹¬ç«‹æ€§)</div>
      <div class="score-value" id="max-sep">0.0Â°</div>
    </div>
  </div>

  <div class="controls">
    <label for="upload">ğŸ“¹ å‹•ç”»é¸æŠ<input type="file" id="upload" accept="video/*" style="display:none"></label>
    <button onclick="togglePlay()" id="btn-play">å†ç”Ÿ/åœæ­¢</button>
    <button onclick="saveImage()" style="background: #0055ff;">ğŸ“¸ è§£æç”»åƒã‚’ä¿å­˜</button>
    <button onclick="resetMax()">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
  <p style="font-size: 12px; color: #888; margin-top: 10px;">â€»ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã®ç¬é–“ã‚’æ¤œçŸ¥ã™ã‚‹ã¨è‡ªå‹•ã§åœæ­¢ã—ã¾ã™</p>
</div>

<a id="download-link"></a>

<script>
  const videoElement = document.getElementById('input_video');
  const canvasElement = document.getElementById('output_canvas');
  const canvasCtx = canvasElement.getContext('2d');
  const currentSepDisplay = document.getElementById('current-sep');
  const maxSepDisplay = document.getElementById('max-sep');

  let maxSep = 0;
  let isImpactDetected = false;
  let lastWristX = 0;

  const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
  pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5 });

  pose.onResults((results) => {
    canvasElement.width = results.image.width;
    canvasElement.height = results.image.height;
    
    // èƒŒæ™¯ï¼šã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰å›ºå®š
    canvasCtx.fillStyle = "#000";
    canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);

    if (results.poseLandmarks) {
      const lm = results.poseLandmarks;
      const lSh = lm[11], rSh = lm[12], lHip = lm[23], rHip = lm[24], lWr = lm[15];

      // 1. æ»è»¢å·®ã®è¨ˆç®—
      const shAng = Math.atan2(rSh.y - lSh.y, rSh.x - lSh.x) * 180 / Math.PI;
      const hipAng = Math.atan2(rHip.y - lHip.y, rHip.x - lHip.x) * 180 / Math.PI;
      const sep = Math.abs(shAng - hipAng);
      
      currentSepDisplay.innerText = sep.toFixed(1) + "Â°";
      if (sep > maxSep) {
        maxSep = sep;
        maxSepDisplay.innerText = maxSep.toFixed(1) + "Â°";
      }

      // 2. ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç°¡æ˜“æ¤œçŸ¥ï¼ˆæ‰‹é¦–ãŒä½“å¹¹ã‚’è¶…ãˆã¦åŠ é€Ÿã—ãŸç¬é–“ï¼‰
      const wristSpeed = Math.abs(lWr.x - lastWristX);
      if (!isImpactDetected && lWr.x < lSh.x && wristSpeed > 0.05) {
        isImpactDetected = true;
        videoElement.pause();
        document.getElementById('btn-play').innerText = "å†é–‹";
      }
      lastWristX = lWr.x;

      // 3. æç”»
      drawConnectors(canvasCtx, lm, POSE_CONNECTIONS, {color: '#333', lineWidth: 2});
      
      // è‚©ç”²å¸¯ãƒ©ã‚¤ãƒ³
      canvasCtx.beginPath();
      canvasCtx.moveTo(lSh.x * canvasElement.width, lSh.y * canvasElement.height);
      canvasCtx.lineTo(rSh.x * canvasElement.width, rSh.y * canvasElement.height);
      canvasCtx.strokeStyle = (sep > 35) ? "#00ffcc" : "#ff3366"; // 35åº¦ä»¥ä¸Šãªã‚‰é’ï¼ˆåˆæ ¼ï¼‰
      canvasCtx.lineWidth = 10;
      canvasCtx.stroke();

      // æ•°å€¤ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤æç”»ï¼ˆç”»åƒä¿å­˜ç”¨ï¼‰
      canvasCtx.fillStyle = "#fff";
      canvasCtx.font = "30px sans-serif";
      canvasCtx.fillText("Torsion: " + sep.toFixed(1) + "Â°", 50, 50);
    }
  });

  async function renderLoop() {
    if (!videoElement.paused && !videoElement.ended) {
      await pose.send({image: videoElement});
    }
    requestAnimationFrame(renderLoop);
  }

  document.getElementById('upload').addEventListener('change', function(e) {
    maxSep = 0;
    isImpactDetected = false;
    videoElement.src = URL.createObjectURL(e.target.files[0]);
    videoElement.onloadedmetadata = () => {
      videoElement.play();
      renderLoop();
    };
  });

  function togglePlay() {
    if (videoElement.paused) {
      isImpactDetected = false; // å†é–‹æ™‚ã¯æ¤œçŸ¥ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
      videoElement.play();
      document.getElementById('btn-play').innerText = "åœæ­¢";
    } else {
      videoElement.pause();
      document.getElementById('btn-play').innerText = "å†ç”Ÿ";
    }
  }

  function resetMax() {
    maxSep = 0;
    maxSepDisplay.innerText = "0.0Â°";
  }

  function saveImage() {
    const link = document.getElementById('download-link');
    link.href = canvasElement.toDataURL("image/png");
    link.download = "analysis_capture.png";
    link.click();
  }
</script>
</body>
</html>
