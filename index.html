<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Kinetic Pro Dual</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <style>
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; color: #fff; font-family: sans-serif; }
    #layout { display: grid; grid-template-rows: 70px 1fr 340px; width: 100vw; height: 100vh; }
    .header { background: #1a1a1a; display: flex; gap: 8px; padding: 10px; align-items: center; border-bottom: 1px solid #333; }
    .top-btn { flex: 1; height: 40px; background: #333; color: #fff; border: 1px solid #555; border-radius: 6px; font-weight: bold; font-size: 12px; display: flex; align-items: center; justify-content: center; text-align: center; }
    
    /* 2ç”»é¢åˆ†å‰²ï¼šãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ */
    .main-view { display: flex; width: 100%; height: 100%; background: #000; gap: 2px; }
    .view-pane { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; border: 1px solid #222; }
    canvas { width: 100%; height: 100%; object-fit: contain; }

    .deck { background: #111; border-top: 2px solid #444; padding: 15px 20px 100px 20px; box-sizing: border-box; }
    .slider-row { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
    .play-trigger { width: 70px; height: 70px; border-radius: 50%; background: #00ffcc; color: #000; border: none; font-size: 32px; flex-shrink: 0; }
    .time-txt { color: #00ffcc; font-family: monospace; font-size: 18px; font-weight: bold; margin-bottom: 5px; }
    input[type="range"] { width: 100%; height: 40px; accent-color: #00ffcc; }

    .btn-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .f-btn { flex: 1; height: 55px; background: #2a2a2a; color: #fff; border: 1px solid #555; border-radius: 12px; font-weight: bold; font-size: 14px; }
    .rec-btn { background: #333; color: #00ffcc; border: 2px solid #00ffcc; }
    .rec-active { background: #ff3366 !important; color: #fff !important; animation: blink 1s infinite; }
    .slow-active { background: #ffaa00 !important; color: #000 !important; }
    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    .label-tag { position: absolute; top: 10px; left: 10px; background: rgba(0,255,204,0.3); padding: 2px 8px; border-radius: 4px; font-size: 10px; pointer-events: none; }
  </style>
</head>
<body>

<div id="layout">
  <div class="header">
    <label class="top-btn">ğŸ“¹ å·¦å‹•ç”»<input type="file" id="upL" accept="video/*" style="display:none"></label>
    <label class="top-btn">ğŸ“¹ å³å‹•ç”»<input type="file" id="upR" accept="video/*" style="display:none"></label>
    <select id="md" class="top-btn"><option value="pitch">æŠ•çƒ</option><option value="bat">æ‰“æ’ƒ</option></select>
  </div>

  <div class="main-view">
    <div class="view-pane"><canvas id="cvL"></canvas><div class="label-tag">LEFT</div></div>
    <div class="view-pane"><canvas id="cvR"></canvas><div class="label-tag">RIGHT</div></div>
  </div>

  <div class="deck">
    <div class="slider-row">
      <button class="play-trigger" id="pp">â–¶</button>
      <div style="flex:1">
        <div class="time-txt"><span id="cn">0.00</span> / <span id="tn">0.00</span>s</div>
        <input type="range" id="sk" value="0" step="0.001">
      </div>
    </div>
    <div class="btn-row"><button id="recBtn" class="f-btn rec-btn" onclick="toggleRec()">â— æ¯”è¼ƒå‹•ç”»ã‚’ä¿å­˜</button></div>
    <div class="btn-row">
      <button class="f-btn" onclick="jump(-0.033)">â—€ æˆ»ã™</button>
      <button class="f-btn" id="sl" onclick="slow()">SLOW (1x)</button>
      <button class="f-btn" onclick="jump(0.033)">é€ã‚‹ â–¶</button>
    </div>
  </div>
</div>

<video id="vdL" playsinline muted style="display:none"></video>
<video id="vdR" playsinline muted style="display:none"></video>

<script>
  // ãƒ¡ã‚¤ãƒ³è¦ç´ ï¼ˆå·¦å³åˆ†ï¼‰
  const vds = { L: document.getElementById('vdL'), R: document.getElementById('vdR') };
  const cvs = { L: document.getElementById('cvL'), R: document.getElementById('cvR') };
  const ctxs = { L: cvs.L.getContext('2d'), R: cvs.R.getContext('2d') };
  const sk = document.getElementById('sk'), pp = document.getElementById('pp');
  let seeking = false, recorder, chunks = [];

  // MediaPipe Poseï¼ˆå·¦å³ã§å…±æœ‰ï¼‰
  const pose = new Pose({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
  pose.setOptions({modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});

  // æç”»ãƒ­ã‚¸ãƒƒã‚¯
  async function processFrame(side) {
    const vd = vds[side], cv = cvs[side], ctx = ctxs[side];
    if (vd.readyState < 2) return;
    
    await pose.send({image: vd});
    // pose.onResults ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªã®ã§ã€ç›´å¾Œã®çµæœã‚’æ‹¾ã†
    pose.onResults((r) => {
      cv.width = r.image.width; cv.height = r.image.height;
      ctx.drawImage(r.image, 0, 0, cv.width, cv.height);
      if (r.poseLandmarks) {
        const lm = r.poseLandmarks;
        const draw = (p1, p2, col, w) => {
          ctx.beginPath(); ctx.moveTo(p1.x * cv.width, p1.y * cv.height); ctx.lineTo(p2.x * cv.width, p2.y * cv.height);
          ctx.strokeStyle = col; ctx.lineWidth = w; ctx.lineCap = "round"; ctx.stroke();
        };
        // ç°¡æ˜“æç”»ï¼ˆ2ç”»é¢æ™‚ã¯è² è·è»½æ¸›ã®ãŸã‚ä¸»è¦ãªç·šã®ã¿ï¼‰
        const isP = document.getElementById('md').value === 'pitch';
        const rExt = isP ? (lm[16].x < lm[14].x + 0.05) : (lm[16].y > lm[14].y);
        const lExt = isP ? (lm[15].x > lm[13].x - 0.05) : (lm[15].y > lm[13].y);
        const rCol = rExt ? "#00e5ff" : "#ff3366", lCol = lExt ? "#00e5ff" : "#ff3366";
        
        // è…•ãƒ»ä½“å¹¹ãƒ»è¶³
        draw(lm[12], lm[14], rCol, 10); draw(lm[14], lm[16], rCol, 6);
        draw(lm[11], lm[13], lCol, 10); draw(lm[13], lm[15], lCol, 6);
        draw(lm[12], lm[11], "#fff", 4); draw(lm[12], lm[24], "#fff", 4); draw(lm[11], lm[23], "#fff", 4); draw(lm[24], lm[23], "#fff", 4);
        draw(lm[24], lm[26], "#00ffcc", 8); draw(lm[26], lm[28], "#00ffcc", 8);
        draw(lm[23], lm[25], "#00ffcc", 8); draw(lm[25], lm[27], "#00ffcc", 8);
      }
    });
  }

  async function stream() {
    if (!vds.L.paused || !vds.R.paused || seeking) {
      await processFrame('L');
      await processFrame('R');
      if (!seeking) {
        sk.value = vds.L.currentTime;
        document.getElementById('cn').innerText = vds.L.currentTime.toFixed(2);
      }
    }
    requestAnimationFrame(stream);
  }

  // åŒæœŸæ“ä½œ
  sk.oninput = () => { 
    vds.L.currentTime = sk.value; 
    vds.R.currentTime = sk.value; 
    document.getElementById('cn').innerText = parseFloat(sk.value).toFixed(2);
  };
  sk.onpointerdown = () => { seeking = true; vds.L.pause(); vds.R.pause(); pp.innerText = "â–¶"; };
  sk.onpointerup = () => { seeking = false; };
  
  pp.onclick = () => { 
    if (vds.L.paused) { vds.L.play(); vds.R.play(); pp.innerText = "â€–"; } 
    else { vds.L.pause(); vds.R.pause(); pp.innerText = "â–¶"; } 
  };

  function jump(d) { 
    vds.L.pause(); vds.R.pause(); pp.innerText = "â–¶";
    vds.L.currentTime += d; vds.R.currentTime += d;
    seeking = true; setTimeout(() => { seeking = false; }, 100);
  }

  function slow() {
    const btn = document.getElementById('sl');
    let rate = vds.L.playbackRate === 1.0 ? 0.25 : (vds.L.playbackRate === 0.25 ? 0.1 : 1.0);
    vds.L.playbackRate = vds.R.playbackRate = rate;
    btn.innerText = `SLOW (${rate}x)`;
    rate < 1.0 ? btn.classList.add('slow-active') : btn.classList.remove('slow-active');
  }

  // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼ˆå·¦å³åˆ¥ï¼‰
  document.getElementById('upL').onchange = (e) => loadVd(e, 'L');
  document.getElementById('upR').onchange = (e) => loadVd(e, 'R');

  function loadVd(e, side) {
    const file = e.target.files[0];
    if (file) {
      vds[side].src = URL.createObjectURL(file);
      vds[side].onloadedmetadata = () => {
        if (side === 'L') {
          sk.max = vds.L.duration;
          document.getElementById('tn').innerText = vds.L.duration.toFixed(2);
        }
        stream();
      };
    }
  }

  // ä¿å­˜æ©Ÿèƒ½ï¼ˆå·¦ç”»é¢ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼‰
  function toggleRec() {
    const btn = document.getElementById('recBtn');
    if (!recorder || recorder.state === 'inactive') {
      chunks = [];
      const streamCanvas = cvs.L.captureStream(25); // ã¨ã‚Šã‚ãˆãšå·¦ã‚’ãƒ¡ã‚¤ãƒ³ã§ä¿å­˜
      recorder = new MediaRecorder(streamCanvas, { mimeType: 'video/webm' });
      recorder.ondataavailable = (e) => chunks.push(e.data);
      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/mp4' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `compare_${Date.now()}.mp4`; a.click();
      };
      recorder.start(100);
      btn.innerText = "â–  æ›¸ãå‡ºã—ã‚’çµ‚äº†"; btn.classList.add('rec-active');
    } else {
      recorder.stop();
      btn.innerText = "â— æ¯”è¼ƒå‹•ç”»ã‚’ä¿å­˜"; btn.classList.remove('rec-active');
    }
  }
</script>
</body>
</html>
