<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Kinetic Linkage Pro - Field Ready</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <style>
    /* é€†ç®—ã®åœŸå°ï¼šç”»é¢ã®ã€Œåº•ã€ã«ã¯ä½•ã‚‚ç½®ã‹ãªã„ */
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; color: #fff; }
    
    #app-grid {
      display: grid;
      grid-template-rows: 50px 1fr 220px; /* ä¸‹éƒ¨220pxã‚’æ“ä½œå°‚ç”¨ã®ã€ŒåœŸå°ã€ã«å›ºå®š */
      width: 100vw; height: 100vh;
    }

    /* æŒ‡å°è€…ã¨é¸æ‰‹ãŒè¦‹ã‚‹ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‹ã‚¿ãƒ¼ */
    .view-monitor { position: relative; background: #000; min-height: 0; display: flex; justify-content: center; align-items: center; }
    canvas { max-width: 98%; max-height: 98%; object-fit: contain; }

    /* ã‚ãªãŸãŒä½¿ã†æ“ä½œãƒ‡ãƒƒã‚­ï¼šãƒ›ãƒ¼ãƒ ãƒãƒ¼ã¨ã®æ¥è§¦ã‚’ç‰©ç†çš„ã«æ–­çµ¶ */
    .op-deck { 
      background: #111; 
      border-top: 1px solid #333;
      /* ã“ã“ãŒé‡è¦ï¼šä¸‹ã‹ã‚‰80pxä»¥ä¸Šæµ®ã‹ã›ã¦ã€ãƒœã‚¿ãƒ³ã‚’é…ç½® */
      padding: 15px 30px 80px 30px; 
      box-sizing: border-box;
    }

    /* å†ç”Ÿã¨ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ä¸¦ã³ï¼šè¦ªæŒ‡ã®å‹•ç·šã‚’æœ€é©åŒ– */
    .main-control { display: flex; align-items: center; gap: 20px; margin-bottom: 25px; }
    .play-btn { 
      width: 70px; height: 70px; border-radius: 50%; background: #00ffcc; 
      color: #000; border: none; font-size: 30px; flex-shrink: 0;
    }

    .seek-area { flex: 1; }
    .time-label { color: #00ffcc; font-family: monospace; font-size: 18px; font-weight: bold; margin-bottom: 8px; }
    input[type="range"] { width: 100%; height: 40px; accent-color: #00ffcc; cursor: pointer; }

    /* ã€Œã‚³ãƒé€ã‚Šã€ãƒœã‚¿ãƒ³ï¼šåŸ‹ã¾ã£ã¦ã„ãŸã‚‚ã®ã‚’å®Œå…¨ã«æ•‘å‡º */
    .sub-control { display: flex; gap: 15px; }
    .field-btn { 
      flex: 1; height: 55px; background: #2a2a2a; color: #fff; 
      border: 1px solid #555; border-radius: 12px; font-weight: bold; font-size: 16px;
    }
    .field-btn:active { background: #444; }
    .btn-active { background: #00ffcc !important; color: #000 !important; }

    /* é¸æ‰‹ã«è¦‹ã›ã‚‹è§£æã‚¿ã‚° */
    .analysis-tag { position: absolute; top: 10px; left: 15px; pointer-events: none; }
    .tag { background: rgba(0,0,0,0.8); padding: 5px 12px; border-radius: 4px; font-size: 13px; margin-bottom: 5px; border-left: 4px solid #00ffcc; }

    .header { background: #1a1a1a; display: flex; gap: 10px; padding: 0 15px; align-items: center; }
    select, .up-btn { background: #333; color: #fff; border: 1px solid #555; padding: 8px; border-radius: 6px; flex: 1; text-align: center; font-size: 13px; }
  </style>
</head>
<body>

<div id="app-grid">
  <div class="header">
    <label class="up-btn">ğŸ“¹ å‹•ç”»é¸æŠ<input type="file" id="u" accept="video/*" style="display:none"></label>
    <select id="m"><option value="pitch">æŠ•çƒè§£æ</option><option value="bat">æ‰“æ’ƒè§£æ</option></select>
    <select id="v-mode"><option value="both">å®Ÿå†™ï¼‹éª¨æ ¼</option><option value="stick">éª¨æ ¼ã®ã¿</option></select>
  </div>

  <div class="view-monitor">
    <canvas id="c"></canvas>
    <div class="analysis-tag">
      <div id="ra" class="tag">å³è…•: --</div>
      <div id="la" class="tag">å·¦è…•: --</div>
    </div>
  </div>

  <div class="op-deck">
    <div class="main-control">
      <button class="play-btn" id="p">â–¶</button>
      <div class="seek-area">
        <div class="time-label"><span id="t-n">0.00</span> / <span id="t-d">0.00</span>s</div>
        <input type="range" id="s" value="0" step="0.001">
      </div>
    </div>
    <div class="sub-control">
      <button class="field-btn" onclick="step(-0.033)">â—€ æˆ»ã™</button>
      <button class="field-btn" id="sl" onclick="slow()">SLOW (0.25x)</button>
      <button class="field-btn" onclick="step(0.033)">é€ã‚‹ â–¶</button>
    </div>
  </div>
</div>

<video id="vd" playsinline muted style="display:none"></video>

<script>
  const vd = document.getElementById('vd'), c = document.getElementById('c'), ctx = c.getContext('2d');
  const s = document.getElementById('s'), p = document.getElementById('p');
  let seeking = false;

  const pose = new Pose({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
  pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

  pose.onResults((r) => {
    if (!r.image) return;
    c.width = r.image.width; c.height = r.image.height;
    ctx.clearRect(0, 0, c.width, c.height);
    if (document.getElementById('v-mode').value !== 'stick') ctx.drawImage(r.image, 0, 0, c.width, c.height);
    
    if (r.poseLandmarks) {
      const lm = r.poseLandmarks;
      const draw = (p1, p2, col, w) => {
        ctx.beginPath(); ctx.moveTo(p1.x*c.width, p1.y*c.height);
        ctx.lineTo(p2.x*c.width, p2.y*c.height);
        ctx.strokeStyle = col; ctx.lineWidth = w; ctx.lineCap = "round"; ctx.stroke();
      };
      // è§£æè¡¨ç¤ºï¼šé ­ã€èƒ¸éƒ­ã€è…•ã€è„š
      const nose = lm[0], ear = { x: (lm[7].x + lm[8].x)/2, y: (lm[7].y + lm[8].y)/2 };
      draw(nose, { x: nose.x + (nose.x - ear.x), y: nose.y + (nose.y - ear.y) }, "#ffff00", 4);
      const isP = document.getElementById('m').value === 'pitch';
      const rExt = isP ? (lm[16].x < lm[14].x + 0.05) : (lm[16].y > lm[14].y);
      const rCol = rExt ? "#00e5ff" : "#ff3366";
      draw(lm[12], lm[14], rCol, 12); draw(lm[14], lm[16], rCol, 8);
      document.getElementById('ra').innerText = `å³è…•: ${rExt ? 'ã‚¿ãƒ¡' : 'è§£æ”¾'}`;
      document.getElementById('ra').style.borderColor = rCol;
      const lExt = isP ? (lm[15].x > lm[13].x - 0.05) : (lm[15].y > lm[13].y);
      const lCol = lExt ? "#00e5ff" : "#ff3366";
      draw(lm[11], lm[13], lCol, 12); draw(lm[13], lm[15], lCol, 8);
      document.getElementById('la').innerText = `å·¦è…•: ${lExt ? 'ã‚¿ãƒ¡' : 'è§£æ”¾'}`;
      document.getElementById('la').style.borderColor = lCol;
      draw(lm[24], lm[26], "#00ffcc", 10); draw(lm[26], lm[28], "#00ffcc", 10);
      draw(lm[23], lm[25], "#00ffcc", 10); draw(lm[25], lm[27], "#00ffcc", 10);
    }
    if (!seeking) { s.value = vd.currentTime; document.getElementById('t-n').innerText = vd.currentTime.toFixed(2); }
  });

  p.onclick = () => { if (vd.paused) { vd.play(); p.innerText = "â€–"; } else { vd.pause(); p.innerText = "â–¶"; } };
  s.onpointerdown = () => { seeking = true; vd.pause(); p.innerText = "â–¶"; };
  s.onpointerup = () => { seeking = false; };
  s.oninput = () => { vd.currentTime = s.value; document.getElementById('t-n').innerText = parseFloat(s.value).toFixed(2); pose.send({image: vd}); };
  
  function step(d) { vd.pause(); p.innerText = "â–¶"; vd.currentTime += d; pose.send({image: vd}); }
  function slow() { vd.playbackRate = vd.playbackRate === 1.0 ? 0.25 : 1.0; document.getElementById('sl').classList.toggle('btn-active', vd.playbackRate === 0.25); }

  document.getElementById('u').onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
      vd.src = URL.createObjectURL(file);
      vd.onloadedmetadata = () => { s.max = vd.duration; document.getElementById('t-d').innerText = vd.duration.toFixed(2); vd.play(); p.innerText = "â€–"; requestAnimationFrame(render); };
    }
  };
  async function render() { if (!vd.paused || seeking) { await pose.send({image: vd}); } requestAnimationFrame(render); }
</script>
</body>
</html>
