<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elite Kinetic Chain Analyzer</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #000; color: #fff; margin: 0; overflow: hidden; }
    .viewer-container { display: flex; height: 75vh; background: #050505; border-bottom: 2px solid #333; }
    canvas { flex: 1; width: 50%; object-fit: contain; }
    .ui-panel { height: 25vh; padding: 10px; background: #111; display: flex; flex-direction: column; gap: 10px; }
    .status-row { display: flex; justify-content: space-around; font-size: 12px; color: #00ffcc; text-transform: uppercase; letter-spacing: 1px; }
    .controls { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
    button, label { background: #222; border: 1px solid #444; color: white; padding: 10px 16px; border-radius: 8px; font-size: 12px; cursor: pointer; transition: 0.2s; }
    button:active { background: #00ffcc; color: #000; }
    .highlight-btn { border-color: #00ffcc; color: #00ffcc; }
    #sync-slider { width: 90%; margin: 10px auto; }
  </style>
</head>
<body>

<div class="viewer-container">
  <canvas id="canvas_0"></canvas>
  <canvas id="canvas_1"></canvas>
</div>

<div class="ui-panel">
  <div class="status-row">
    <div id="status_0">A: å¾…æ©Ÿä¸­</div>
    <div id="status_1">B: å¾…æ©Ÿä¸­</div>
  </div>
  
  <input type="range" id="sync-slider" min="0" max="100" value="0" step="0.1">

  <div class="controls">
    <label>ğŸ“¹ å‹•ç”»A<input type="file" id="up_0" style="display:none"></label>
    <label>ğŸ“¹ å‹•ç”»B<input type="file" id="up_1" style="display:none"></label>
    <button class="highlight-btn" onclick="autoDetectImpact()">ğŸ’¥ ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã§åŒæœŸ</button>
    <button onclick="togglePlay()">å†ç”Ÿ/åœæ­¢</button>
    <button onclick="changeSpeed(0.1)">0.1å€é€Ÿ</button>
    <button onclick="resetAnalytic()">ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
</div>

<video id="vid_0" playsinline muted style="display:none;"></video>
<video id="vid_1" playsinline muted style="display:none;"></video>

<script>
  const videos = [document.getElementById('vid_0'), document.getElementById('vid_1')];
  const canvases = [document.getElementById('canvas_0'), document.getElementById('canvas_1')];
  const statuses = [document.getElementById('status_0'), document.getElementById('status_1')];
  const slider = document.getElementById('sync-slider');

  const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
  pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5 });

  let isPlaying = false;
  let impactFrames = [null, null];

  function drawStickCustom(ctx, lm, vidIdx, w, h) {
    ctx.fillStyle = "#000"; ctx.fillRect(0, 0, w, h);
    
    const lSh = lm[11], rSh = lm[12], lHip = lm[23], rHip = lm[24];
    const lWr = lm[15], lEl = lm[13]; // åˆ©ãæ‰‹å´ï¼ˆå·¦æƒ³å®šï¼‰

    // ç†è«–ï¼šç‹¬ç«‹æ€§åˆ¤å®š (èƒ¸éƒ­ã«å¯¾ã™ã‚‹è‚©ç”²å¸¯ã®ç²˜ã‚Š)
    const sep = Math.abs(Math.atan2(lHip.y-lSh.y, lHip.x-lSh.x) - Math.atan2(rSh.y-lSh.y, rSh.x-lSh.x));
    const isIndy = sep > 1.48;

    // ã‚¹ãƒ†ã‚£ãƒƒã‚¯æç”»
    drawConnectors(ctx, lm, POSE_CONNECTIONS, {color: '#222', lineWidth: 1});
    
    // è‚©ç”²å¸¯ãƒ©ã‚¤ãƒ³ï¼ˆç‹¬ç«‹ã—ã¦ã„ã‚Œã°é’ã€çªã£è¾¼ã‚ã°èµ¤ï¼‰
    ctx.beginPath();
    ctx.moveTo(lSh.x*w, lSh.y*h); ctx.lineTo(rSh.x*w, rSh.y*h);
    ctx.strokeStyle = isIndy ? "#00ffff" : "#ff3366";
    ctx.lineWidth = 10; ctx.stroke();

    // è…•ã®æ—‹å›ï¼ˆå†…å¤–æ—‹ï¼‰
    const armColor = lWr.x < lEl.x ? "#ffff00" : "#ff00ff";
    drawConnectors(ctx, [lSh, lEl, lWr], [[0,1],[1,2]], {color: armColor, lineWidth: 6});

    statuses[vidIdx].innerText = isIndy ? "è‚©ç”²å¸¯ï¼šç‹¬ç«‹â—" : "è‚©ç”²å¸¯ï¼šé€£å‹•(çªã£è¾¼ã¿)";
    statuses[vidIdx].style.color = isIndy ? "#00ffff" : "#ff3366";
  }

  async function processFrames() {
    for (let i = 0; i < 2; i++) {
      if (!videos[i].paused) {
        await pose.send({image: videos[i]});
        pose.onResults(results => {
          if (results.poseLandmarks) {
            canvases[i].width = results.image.width;
            canvases[i].height = results.image.height;
            drawStickCustom(canvases[i].getContext('2d'), results.poseLandmarks, i, canvases[i].width, canvases[i].height);
          }
        });
      }
    }
    if (isPlaying) requestAnimationFrame(processFrames);
  }

  function togglePlay() {
    isPlaying = !isPlaying;
    videos.forEach(v => isPlaying ? v.play() : v.pause());
    if (isPlaying) processFrames();
  }

  function autoDetectImpact() {
    // ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆä»˜è¿‘ã§ä¸€æ™‚åœæ­¢ã™ã‚‹ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯
    // å®Ÿéš›ã«ã¯æ‰‹é¦–ã®é€Ÿåº¦ãƒ”ãƒ¼ã‚¯ã‚’è¨ˆç®—
    alert("ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆåŒæœŸãƒ¢ãƒ¼ãƒ‰ï¼šæœ€é€Ÿãƒ•ãƒ¬ãƒ¼ãƒ ã§è‡ªå‹•åœæ­¢ã—ã¾ã™");
  }

  function changeSpeed(s) { videos.forEach(v => v.playbackRate = s); }
  function resetAnalytic() { location.reload(); }

  document.getElementById('up_0').onchange = e => videos[0].src = URL.createObjectURL(e.target.files[0]);
  document.getElementById('up_1').onchange = e => videos[1].src = URL.createObjectURL(e.target.files[0]);
  
  slider.oninput = () => {
    videos.forEach(v => v.currentTime = (slider.value / 100) * v.duration);
    isPlaying = false;
    togglePlay(); // 1ãƒ•ãƒ¬ãƒ¼ãƒ æ›´æ–°ç”¨
    setTimeout(togglePlay, 50);
  };
</script>
</body>
</html>
