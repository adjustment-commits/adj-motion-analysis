<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Kinetic Linkage - Field Master</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <style>
    /* ç”»é¢å…¨ä½“ã‚’å›ºå®šã€iPadã®ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ï¼ˆãƒ›ãƒ¼ãƒ ãƒãƒ¼ä»˜è¿‘ï¼‰ã‚’è€ƒæ…® */
    :root { --safe-bottom: env(safe-area-inset-bottom, 30px); }
    html, body { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; background: #000; position: fixed; }
    
    #app-container { display: flex; flex-direction: column; width: 100%; height: 100vh; }

    /* ä¸Šéƒ¨è¨­å®šãƒ‘ãƒãƒ« */
    .ui-top { height: 50px; background: #1a1a1a; display: flex; gap: 8px; padding: 5px 15px; align-items: center; flex-shrink: 0; }
    select, .upload-label { background: #333; color: #fff; border: 1px solid #555; padding: 8px; border-radius: 6px; font-size: 12px; flex: 1; text-align: center; }

    /* ä¸­å¤®æç”»ã‚¨ãƒªã‚¢ */
    .display-area { flex: 1; min-height: 0; position: relative; background: #000; display: flex; justify-content: center; align-items: center; }
    canvas { max-width: 100%; max-height: 100%; object-fit: contain; }

    /* ä¸‹éƒ¨ï¼šç¾å ´æ“ä½œãƒ‡ãƒƒã‚­ï¼ˆã“ã“ã‚’çµ¶å¯¾æ­»å®ˆï¼‰ */
    .ui-bottom { 
      background: #111; 
      border-top: 2px solid #333; 
      /* ãƒ›ãƒ¼ãƒ ãƒãƒ¼å›é¿ã®ãŸã‚ã€ä¸‹ã®ä½™ç™½ã‚’å¤§å¹…ã«ç¢ºä¿(50pxä»¥ä¸Š) */
      padding: 15px 20px calc(var(--safe-bottom) + 30px) 20px; 
      flex-shrink: 0; 
      box-sizing: border-box; 
    }
    
    /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æ¨ªä¸€åˆ—ã«ã€‚æŒ‡ã®å‹•ç·šã‚’æœ€å°åŒ– */
    .main-control-row { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
    .play-circle { 
      width: 65px; height: 65px; background: #00ffcc; color: #000; 
      border: none; border-radius: 50%; font-size: 28px; 
      display: flex; justify-content: center; align-items: center; flex-shrink: 0; 
      box-shadow: 0 0 15px rgba(0,255,204,0.4);
    }
    .play-circle:active { background: #00ccaa; }
    
    /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æœ¬ä½“ */
    .seek-container { flex: 1; display: flex; flex-direction: column; gap: 5px; }
    input[type="range"] { 
      width: 100%; height: 45px; cursor: pointer;
      accent-color: #00ffcc; /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®è‰²ã‚’å¼·èª¿ */
    }
    .time-info { color: #00ffcc; font-family: monospace; font-size: 16px; font-weight: bold; }

    /* ã‚µãƒ–æ“ä½œï¼šã‚³ãƒé€ã‚Šã¨ã‚¹ãƒ­ãƒ¼ */
    .sub-control-row { display: flex; gap: 10px; }
    .btn-frame { 
      flex: 1; height: 50px; background: #2a2a2a; color: #fff; 
      border: 1px solid #444; border-radius: 10px; font-size: 14px; font-weight: bold; 
    }
    .btn-frame:active { background: #444; }
    .active-slow { background: #00ffcc !important; color: #000 !important; }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆãƒãƒƒã‚¸ï¼‰ */
    .badge-area { position: absolute; top: 15px; left: 15px; z-index: 50; pointer-events: none; }
    .badge { background: rgba(0,0,0,0.8); padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-bottom: 4px; border-left: 4px solid #fff; color: #fff; }
  </style>
</head>
<body>

<div id="app-container">
  <div class="ui-top">
    <label class="upload-label">ğŸ“¹ å‹•ç”»é¸æŠ<input type="file" id="upload" accept="video/*" style="display:none"></label>
    <select id="mode-select"><option value="pitch">æŠ•çƒãƒ¢ãƒ¼ãƒ‰</option><option value="bat">æ‰“æ’ƒãƒ¢ãƒ¼ãƒ‰</option></select>
    <select id="view-mode"><option value="both">å®Ÿå†™ï¼‹éª¨æ ¼</option><option value="stick">éª¨æ ¼ã®ã¿</option></select>
  </div>

  <div class="display-area">
    <canvas id="output_canvas"></canvas>
    <div class="badge-area">
      <div id="badge-r" class="badge">å³è…•: --</div>
      <div id="badge-l" class="badge">å·¦è…•: --</div>
    </div>
  </div>

  <div class="ui-bottom">
    <div class="main-control-row">
      <button class="play-circle" id="play-btn">â–¶</button>
      <div class="seek-container">
        <div class="time-info"><span id="time-display">0.00</span> / <span id="duration-display">0.00</span>s</div>
        <input type="range" id="seek-bar" value="0" step="0.001">
      </div>
    </div>
    
    <div class="sub-control-row">
      <button class="btn-frame" onclick="stepFrame(-1)">â—€ ã‚³ãƒæˆ»ã—</button>
      <button class="btn-frame" id="slow-btn" onclick="toggleSlow()">SLOW (0.25x)</button>
      <button class="btn-frame" onclick="stepFrame(1)">ã‚³ãƒé€ã‚Š â–¶</button>
    </div>
  </div>
</div>

<video id="input_video" playsinline muted style="display:none;"></video>

<script>
  const video = document.getElementById('input_video');
  const canvas = document.getElementById('output_canvas');
  const ctx = canvas.getContext('2d');
  const seekBar = document.getElementById('seek-bar');
  const playBtn = document.getElementById('play-btn');
  const timeDisplay = document.getElementById('time-display');
  const durationDisplay = document.getElementById('duration-display');
  
  let isSeeking = false;

  const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
  pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

  pose.onResults((results) => {
    canvas.width = results.image ? results.image.width : canvas.width;
    canvas.height = results.image ? results.image.height : canvas.height;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (document.getElementById('view-mode').value !== 'stick' && results.image) {
      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
    } else {
      ctx.fillStyle = "#000"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    if (results.poseLandmarks) {
      const lm = results.poseLandmarks;
      const draw = (p1, p2, col, w) => {
        ctx.beginPath(); ctx.moveTo(p1.x*canvas.width, p1.y*canvas.height);
        ctx.lineTo(p2.x*canvas.width, p2.y*canvas.height);
        ctx.strokeStyle = col; ctx.lineWidth = w; ctx.lineCap = "round"; ctx.stroke();
      };

      // 1. é ­ã®ãƒ™ã‚¯ãƒˆãƒ«
      const nose = lm[0];
      const earAvg = { x: (lm[7].x + lm[8].x)/2, y: (lm[7].y + lm[8].y)/2 };
      const headDir = { x: nose.x + (nose.x - earAvg.x), y: nose.y + (nose.y - earAvg.y) };
      draw(nose, headDir, "#ffff00", 4);

      // 2. èƒ¸éƒ­ãƒœãƒƒã‚¯ã‚¹ï¼ˆåŠèº«åˆ¤å®šæ–‡å­—ãªã—ï¼‰
      ctx.beginPath();
      ctx.moveTo(lm[11].x*canvas.width, lm[11].y*canvas.height);
      ctx.lineTo(lm[12].x*canvas.width, lm[12].y*canvas.height);
      ctx.lineTo(lm[24].x*canvas.width, lm[24].y*canvas.height);
      ctx.lineTo(lm[23].x*canvas.width, lm[23].y*canvas.height);
      ctx.closePath();
      ctx.fillStyle = "rgba(255,255,255,0.15)"; ctx.fill(); ctx.strokeStyle = "#fff"; ctx.stroke();

      const isPitch = document.getElementById('mode-select').value === 'pitch';

      // 3. å·¦å³è…•ï¼šã‚¿ãƒ¡ï¼ˆé’ï¼‰ã¨è§£æ”¾ï¼ˆèµ¤ï¼‰
      const rExt = isPitch ? (lm[16].x < lm[14].x + 0.05) : (lm[16].y > lm[14].y);
      const rCol = rExt ? "#00e5ff" : "#ff3366";
      draw(lm[12], lm[14], rCol, 12); draw(lm[14], lm[16], rCol, 8);
      document.getElementById('badge-r').innerText = `å³è…•: ${rExt ? 'ã‚¿ãƒ¡' : 'è§£æ”¾'}`;
      document.getElementById('badge-r').style.borderColor = rCol;

      const lExt = isPitch ? (lm[15].x > lm[13].x - 0.05) : (lm[15].y > lm[13].y);
      const lCol = lExt ? "#00e5ff" : "#ff3366";
      draw(lm[11], lm[13], lCol, 12); draw(lm[13], lm[15], lCol, 8);
      document.getElementById('badge-l').innerText = `å·¦è…•: ${lExt ? 'ã‚¿ãƒ¡' : 'è§£æ”¾'}`;
      document.getElementById('badge-l').style.borderColor = lCol;

      draw(lm[24], lm[26], "#00ffcc", 10); draw(lm[26], lm[28], "#00ffcc", 10);
      draw(lm[23], lm[25], "#00ffcc", 10); draw(lm[25], lm[27], "#00ffcc", 10);
    }

    if (!isSeeking) {
      seekBar.value = video.currentTime;
      timeDisplay.innerText = video.currentTime.toFixed(2);
    }
  });

  // æ“ä½œãƒ­ã‚¸ãƒƒã‚¯
  playBtn.onclick = () => {
    if (video.paused) { video.play(); playBtn.innerText = "â€–"; }
    else { video.pause(); playBtn.innerText = "â–¶"; }
  };

  seekBar.onpointerdown = () => { isSeeking = true; video.pause(); playBtn.innerText = "â–¶"; };
  seekBar.onpointerup = () => { isSeeking = false; };
  seekBar.oninput = () => {
    video.currentTime = seekBar.value;
    timeDisplay.innerText = parseFloat(seekBar.value).toFixed(2);
    pose.send({image: video});
  };

  function stepFrame(dir) {
    video.pause();
    playBtn.innerText = "â–¶";
    video.currentTime += (dir * 0.033);
    pose.send({image: video});
  }

  function toggleSlow() {
    video.playbackRate = video.playbackRate === 1.0 ? 0.25 : 1.0;
    document.getElementById('slow-btn').classList.toggle('active-slow', video.playbackRate === 0.25);
  }

  document.getElementById('upload').onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
      video.src = URL.createObjectURL(file);
      video.onloadedmetadata = () => { 
        seekBar.max = video.duration; 
        durationDisplay.innerText = video.duration.toFixed(2);
        video.play(); playBtn.innerText = "â€–";
        requestAnimationFrame(render); 
      };
    }
  };

  async function render() {
    if (!video.paused || isSeeking) { await pose.send({image: video}); }
    requestAnimationFrame(render);
  }
</script>
</body>
</html>
