<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Kinetic Pro Precision</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <style>
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; color: #fff; font-family: sans-serif; }
    #layout { display: flex; flex-direction: column; width: 100vw; height: 100vh; }
    .header { height: 70px; background: #1a1a1a; display: flex; gap: 10px; padding: 0 15px; align-items: center; border-bottom: 1px solid #333; flex-shrink: 0; }
    .top-btn { flex: 1; height: 45px; background: #333; color: #fff; border: 1px solid #555; border-radius: 8px; font-weight: bold; font-size: 14px; display: flex; align-items: center; justify-content: center; }
    .main-view { flex: 1; position: relative; min-height: 0; display: flex; justify-content: center; align-items: center; }
    canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
    .deck { height: 360px; background: #111; border-top: 2px solid #444; padding: 15px 20px 100px 20px; box-sizing: border-box; flex-shrink: 0; }
    
    /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼å‘¨ã‚Šã®å¼·åŒ– */
    .slider-row { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
    .play-trigger { width: 70px; height: 70px; border-radius: 50%; background: #00ffcc; color: #000; border: none; font-size: 32px; flex-shrink: 0; }
    .seek-box { flex: 1; }
    .time-txt { color: #00ffcc; font-family: monospace; font-size: 18px; font-weight: bold; margin-bottom: 5px; }
    input[type="range"] { width: 100%; height: 45px; accent-color: #00ffcc; cursor: pointer; }

    /* å¾®èª¿æ•´ãƒœã‚¿ãƒ³ */
    .btn-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .f-btn { flex: 1; height: 50px; background: #2a2a2a; color: #fff; border: 1px solid #555; border-radius: 10px; font-weight: bold; font-size: 14px; }
    .step-btn { background: #444; color: #00ffcc; flex: 0.5; }
    .rec-btn { background: #333; color: #00ffcc; border: 2px solid #00ffcc; height: 60px; font-size: 16px; }
    .rec-active { background: #ff3366 !important; color: #fff !important; animation: blink 1s infinite; }
    .slow-active { background: #ffaa00 !important; color: #000 !important; }
    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    .tags { position: absolute; top: 15px; left: 15px; pointer-events: none; }
    .badge { background: rgba(0,0,0,0.8); padding: 6px 12px; border-radius: 4px; font-size: 12px; margin-bottom: 4px; border-left: 4px solid #00ffcc; }
  </style>
</head>
<body>
<div id="layout">
  <div class="header">
    <label class="top-btn">ğŸ“¹ å‹•ç”»é¸æŠ<input type="file" id="up" accept="video/*" style="display:none"></label>
    <select id="md" class="top-btn"><option value="pitch">æŠ•çƒ</option><option value="bat">æ‰“æ’ƒ</option></select>
    <select id="vw" class="top-btn"><option value="both">å®Ÿå†™ï¼‹éª¨æ ¼</option><option value="stick">éª¨æ ¼ã®ã¿</option></select>
  </div>
  <div class="main-view"><canvas id="cv"></canvas><div class="tags"><div id="r-txt" class="badge">å³: --</div><div id="l-txt" class="badge">å·¦: --</div></div></div>
  <div class="deck">
    <div class="slider-row">
      <button class="play-trigger" id="pp">â–¶</button>
      <div class="seek-box">
        <div class="time-txt"><span id="cn">0.00</span> / <span id="tn">0.00</span>s</div>
        <input type="range" id="sk" value="0" step="0.001">
      </div>
    </div>
    <div class="btn-row">
      <button class="f-btn step-btn" onclick="jump(-0.01)">-0.01s</button>
      <button class="f-btn" onclick="jump(-0.033)">â—€ æˆ»ã™</button>
      <button class="f-btn" id="sl" onclick="slow()">SLOW (1x)</button>
      <button class="f-btn" onclick="jump(0.033)">é€ã‚‹ â–¶</button>
      <button class="f-btn step-btn" onclick="jump(0.01)">+0.01s</button>
    </div>
    <div class="btn-row"><button id="recBtn" class="f-btn rec-btn" onclick="toggleRec()">â— è§£æå‹•ç”»ã‚’ã‚«ãƒ¡ãƒ©ãƒ­ãƒ¼ãƒ«ã¸</button></div>
  </div>
</div>
<video id="vd" playsinline muted style="display:none"></video>

<script>
  const vd = document.getElementById('vd'), cv = document.getElementById('cv'), ctx = cv.getContext('2d'), sk = document.getElementById('sk'), pp = document.getElementById('pp');
  let seeking = false, recorder, chunks = [];

  const pose = new Pose({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
  pose.setOptions({modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});

  pose.onResults((r) => {
    if (!r.image) return;
    cv.width = r.image.width; cv.height = r.image.height;
    ctx.clearRect(0, 0, cv.width, cv.height);
    if (document.getElementById('vw').value !== 'stick') ctx.drawImage(r.image, 0, 0, cv.width, cv.height);
    if (r.poseLandmarks) {
      const lm = r.poseLandmarks;
      const draw = (p1, p2, col, w) => {
        ctx.beginPath(); ctx.moveTo(p1.x * cv.width, p1.y * cv.height); ctx.lineTo(p2.x * cv.width, p2.y * cv.height);
        ctx.strokeStyle = col; ctx.lineWidth = w; ctx.lineCap = "round"; ctx.stroke();
      };
      ctx.beginPath(); ctx.moveTo(lm[11].x * cv.width, lm[11].y * cv.height); ctx.lineTo(lm[12].x * cv.width, lm[12].y * cv.height);
      ctx.lineTo(lm[24].x * cv.width, lm[24].y * cv.height); ctx.lineTo(lm[23].x * cv.width, lm[23].y * cv.height);
      ctx.closePath(); ctx.fillStyle = "rgba(255, 255, 255, 0.2)"; ctx.fill(); ctx.strokeStyle = "#ffffff"; ctx.lineWidth = 2; ctx.stroke();
      const isP = document.getElementById('md').value === 'pitch';
      const rExt = isP ? (lm[16].x < lm[14].x + 0.05) : (lm[16].y > lm[14].y);
      const rCol = rExt ? "#00e5ff" : "#ff3366";
      draw(lm[12], lm[14], rCol, 12); draw(lm[14], lm[16], rCol, 8);
      document.getElementById('r-txt').innerText = `å³: ${rExt ? 'ã‚¿ãƒ¡' : 'è§£æ”¾'}`;
      const lExt = isP ? (lm[15].x > lm[13].x - 0.05) : (lm[15].y > lm[13].y);
      const lCol = lExt ? "#00e5ff" : "#ff3366";
      draw(lm[11], lm[13], lCol, 12); draw(lm[13], lm[15], lCol, 8);
      document.getElementById('l-txt').innerText = `å·¦: ${lExt ? 'ã‚¿ãƒ¡' : 'è§£æ”¾'}`;
      draw(lm[24], lm[26], "#00ffcc", 10); draw(lm[26], lm[28], "#00ffcc", 10);
      draw(lm[23], lm[25], "#00ffcc", 10); draw(lm[25], lm[27], "#00ffcc", 10);
    }
  });

  async function stream() { 
    if (!vd.paused || seeking) { 
      await pose.send({image: vd}); 
      if (!seeking) { 
        sk.value = vd.currentTime; 
        document.getElementById('cn').innerText = vd.currentTime.toFixed(2); 
      } 
    } 
    requestAnimationFrame(stream); 
  }

  sk.oninput = () => { seeking = true; vd.currentTime = sk.value; document.getElementById('cn').innerText = parseFloat(sk.value).toFixed(2); };
  sk.onpointerup = () => { seeking = false; };
  pp.onclick = () => { if (vd.paused) { vd.play(); pp.innerText = "â€–"; } else { vd.pause(); pp.innerText = "â–¶"; } };
  function jump(d) { vd.currentTime += d; seeking = true; setTimeout(() => { seeking = false; }, 50); }

  function slow() {
    const btn = document.getElementById('sl');
    let rates = [1.0, 0.25, 0.1];
    let next = rates[(rates.indexOf(vd.playbackRate) + 1) % rates.length];
    vd.playbackRate = next;
    btn.innerText = `SLOW (${next}x)`;
    next < 1.0 ? btn.classList.add('slow-active') : btn.classList.remove('slow-active');
  }

  document.getElementById('up').onchange = (e) => {
    const file = e.target.files[0];
    if (file) { vd.src = URL.createObjectURL(file); vd.onloadedmetadata = () => { sk.max = vd.duration; document.getElementById('tn').innerText = vd.duration.toFixed(2); vd.play(); pp.innerText = "â€–"; stream(); }; }
  };

  // --- ä¿å­˜ã®ä¿®æ­£ ---
  function toggleRec() {
    const btn = document.getElementById('recBtn');
    if (!recorder || recorder.state === 'inactive') {
      chunks = [];
      const streamCanvas = cv.captureStream(25);
      recorder = new MediaRecorder(streamCanvas, { mimeType: 'video/webm;codecs=vp8' });
      recorder.ondataavailable = (e) => chunks.push(e.data);
      recorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'video/mp4' });
        const url = URL.createObjectURL(blob);
        
        // iPad Safariã§ç¢ºå®Ÿã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å‡ºã™ãŸã‚ã®å‡¦ç†
        const a = document.createElement('a');
        a.href = url;
        a.download = `analysis_${Date.now()}.mp4`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            alert("iPadã®å³ä¸Šã®ã€â†“ã€ãƒãƒ¼ã‚¯ã‚’ã‚¿ãƒƒãƒ—ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ã€ãƒ“ãƒ‡ã‚ªã‚’ä¿å­˜ã€ã‚’æŠ¼ã™ã¨ã‚«ãƒ¡ãƒ©ãƒ­ãƒ¼ãƒ«ã«å…¥ã‚Šã¾ã™ã€‚");
        }, 1000);
      };
      recorder.start(100);
      btn.innerText = "â–  æ›¸ãå‡ºã—ã‚’çµ‚äº†"; btn.classList.add('rec-active');
    } else {
      recorder.stop();
      btn.innerText = "â— è§£æå‹•ç”»ã‚’ã‚«ãƒ¡ãƒ©ãƒ­ãƒ¼ãƒ«ã¸"; btn.classList.remove('rec-active');
    }
  }
</script>
</body>
</html>
