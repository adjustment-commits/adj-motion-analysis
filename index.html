<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Kinetic Linkage Pro - Full Spec</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <style>
    /* å…¨ä½“è¨­è¨ˆï¼šiPadã®ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ã¨æ“ä½œãƒ‡ãƒƒã‚­ã‚’å®Œå…¨åˆ†é›¢ */
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: -apple-system, sans-serif; color: #fff; }
    #app-grid { 
      display: grid; 
      grid-template-rows: 70px 1fr 220px; /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒ¡ã‚¤ãƒ³ãƒ»ãƒ‡ãƒƒã‚­ */
      width: 100vw; height: 100vh; 
      padding-bottom: env(safe-area-inset-bottom); /* OSã®ãƒãƒ¼ã‚’é¿ã‘ã‚‹ */
    }

    /* 1. ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šã™ã¹ã¦ã®è¨­å®šãƒœã‚¿ãƒ³ã‚’åŒä¸€ã‚µã‚¤ã‚ºã§çµ±ä¸€ */
    .header { 
      background: #1a1a1a; display: flex; gap: 10px; padding: 10px 15px; 
      align-items: center; border-bottom: 1px solid #333; 
    }
    .unified-btn { 
      flex: 1; height: 45px; background: #333; color: #fff; border: 1px solid #555; 
      border-radius: 8px; font-size: 14px; font-weight: bold; 
      display: flex; align-items: center; justify-content: center; cursor: pointer;
    }
    select.unified-btn { appearance: none; -webkit-appearance: none; padding-left: 10px; }

    /* 2. è§£æãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼šé¸æ‰‹ã¨æŒ‡å°è€…ãŒè¦‹ã‚‹å ´æ‰€ */
    .view-monitor { position: relative; min-height: 0; display: flex; justify-content: center; align-items: center; overflow: hidden; }
    canvas { max-width: 100%; max-height: 100%; object-fit: contain; }

    /* 3. æ“ä½œãƒ‡ãƒƒã‚­ï¼šã‚ãªãŸã®è¦ªæŒ‡ãŒå‹•ãå ´æ‰€ï¼ˆãƒ›ãƒ¼ãƒ ãƒãƒ¼ã‹ã‚‰å®Œå…¨ã«æµ®ä¸Šï¼‰ */
    .op-deck { 
      background: #111; border-top: 2px solid #333;
      padding: 20px 30px 60px 30px; /* ä¸‹éƒ¨ãƒãƒ¼ã‚¸ãƒ³ã§ãƒãƒ¼ã‚’ç¢ºå®Ÿã«å›é¿ */
    }
    .main-row { display: flex; align-items: center; gap: 20px; margin-bottom: 25px; }
    .play-btn { 
      width: 75px; height: 75px; border-radius: 50%; background: #00ffcc; color: #000; 
      border: none; font-size: 32px; flex-shrink: 0; box-shadow: 0 4px 15px rgba(0,255,204,0.3);
    }
    .slider-box { flex: 1; }
    .time-label { color: #00ffcc; font-family: 'Courier New', monospace; font-size: 18px; font-weight: bold; margin-bottom: 8px; }
    input[type="range"] { width: 100%; height: 40px; accent-color: #00ffcc; cursor: pointer; }

    .action-row { display: flex; gap: 12px; }
    .action-btn { 
      flex: 1; height: 60px; background: #2a2a2a; color: #fff; 
      border: 1px solid #555; border-radius: 12px; font-weight: bold; font-size: 16px; 
    }
    .active-mode { background: #00ffcc !important; color: #000 !important; }

    /* ç”»é¢ä¸Šã®è§£ææƒ…å ±ãƒãƒƒã‚¸ */
    .info-tags { position: absolute; top: 15px; left: 15px; pointer-events: none; }
    .badge { 
      background: rgba(0,0,0,0.8); padding: 6px 14px; border-radius: 4px; 
      font-size: 13px; margin-bottom: 6px; border-left: 5px solid #00ffcc; 
    }
  </style>
</head>
<body>

<div id="app-grid">
  <div class="header">
    <label class="unified-btn">ğŸ“¹ å‹•ç”»é¸æŠ<input type="file" id="up" accept="video/*" style="display:none"></label>
    <select id="mode" class="unified-btn"><option value="pitch">æŠ•çƒè§£æ</option><option value="bat">æ‰“æ’ƒè§£æ</option></select>
    <select id="view" class="unified-btn"><option value="both">å®Ÿå†™ï¼‹éª¨æ ¼</option><option value="stick">éª¨æ ¼ã®ã¿</option></select>
  </div>

  <div class="view-monitor">
    <canvas id="cv"></canvas>
    <div class="info-tags">
      <div id="ra-val" class="badge">å³è…•: --</div>
      <div id="la-val" class="badge">å·¦è…•: --</div>
    </div>
  </div>

  <div class="op-deck">
    <div class="main-row">
      <button class="play-btn" id="p-toggle">â–¶</button>
      <div class="slider-box">
        <div class="time-label"><span id="t-cur">0.00</span> / <span id="t-dur">0.00</span>s</div>
        <input type="range" id="seek" value="0" step="0.001">
      </div>
    </div>
    <div class="action-row">
      <button class="action-btn" onclick="jump(-0.033)">â—€ 1ã‚³ãƒæˆ»ã™</button>
      <button class="action-btn" id="sl-btn" onclick="toggleSlow()">SLOW (0.25x)</button>
      <button class="action-btn" onclick="jump(0.033)">1ã‚³ãƒé€ã‚‹ â–¶</button>
    </div>
  </div>
</div>

<video id="vd" playsinline muted style="display:none"></video>

<script>
  const vd = document.getElementById('vd'), cv = document.getElementById('cv'), ctx = cv.getContext('2d');
  const seek = document.getElementById('seek'), pBtn = document.getElementById('p-toggle');
  let isSeeking = false, isProcessing = false;

  const pose = new Pose({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
  pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

  // 1. è§£æãƒ»æç”»ãƒ­ã‚¸ãƒƒã‚¯ï¼šç²¾åº¦ã¨ãƒãƒƒãƒ•ã‚¡ã‚’å®Œå…¨ç¶­æŒ
  pose.onResults((r) => {
    if (!r.image) return;
    cv.width = r.image.width; cv.height = r.image.height;
    ctx.clearRect(0, 0, cv.width, cv.height);
    if (document.getElementById('view').value !== 'stick') ctx.drawImage(r.image, 0, 0, cv.width, cv.height);
    
    if (r.poseLandmarks) {
      const lm = r.poseLandmarks;
      const drawL = (p1, p2, col, w) => {
        ctx.beginPath(); ctx.moveTo(p1.x*cv.width, p1.y*cv.height);
        ctx.lineTo(p2.x*cv.width, p2.y*cv.height);
        ctx.strokeStyle = col; ctx.lineWidth = w; ctx.lineCap = "round"; ctx.stroke();
      };

      // è¦–ç·šãƒ™ã‚¯ãƒˆãƒ«
      const nose = lm[0], ear = { x: (lm[7].x + lm[8].x)/2, y: (lm[7].y + lm[8].y)/2 };
      drawL(nose, { x: nose.x + (nose.x - ear.x), y: nose.y + (nose.y - ear.y) }, "#ffff00", 4);

      // èƒ¸éƒ­
      ctx.beginPath();
      ctx.moveTo(lm[11].x*cv.width, lm[11].y*cv.height); ctx.lineTo(lm[12].x*cv.width, lm[12].y*cv.height);
      ctx.lineTo(lm[24].x*cv.width, lm[24].y*cv.height); ctx.lineTo(lm[23].x*cv.width, lm[23].y*cv.height);
      ctx.closePath(); ctx.fillStyle = "rgba(255,255,255,0.15)"; ctx.fill(); ctx.strokeStyle = "#fff"; ctx.stroke();

      const isP = document.getElementById('mode').value === 'pitch';
      
      // å³è…•åˆ¤å®šï¼ˆãƒãƒƒãƒ•ã‚¡0.05ç¶­æŒï¼‰
      const rExt = isP ? (lm[16].x < lm[14].x + 0.05) : (lm[16].y > lm[14].y);
      const rCol = rExt ? "#00e5ff" : "#ff3366";
      drawL(lm[12], lm[14], rCol, 12); drawL(lm[14], lm[16], rCol, 8);
      document.getElementById('ra-val').innerText = `å³è…•: ${rExt ? 'ã‚¿ãƒ¡' : 'è§£æ”¾'}`;
      document.getElementById('ra-val').style.borderColor = rCol;

      // å·¦è…•åˆ¤å®š
      const lExt = isP ? (lm[15].x > lm[13].x - 0.05) : (lm[15].y > lm[13].y);
      const lCol = lExt ? "#00e5ff" : "#ff3366";
      drawL(lm[11], lm[13], lCol, 12); drawL(lm[13], lm[15], lCol, 8);
      document.getElementById('la-val').innerText = `å·¦è…•: ${lExt ? 'ã‚¿ãƒ¡' : 'è§£æ”¾'}`;
      document.getElementById('la-val').style.borderColor = lCol;

      // è„š
      drawL(lm[24], lm[26], "#00ffcc", 10); drawL(lm[26], lm[28], "#00ffcc", 10);
      drawL(lm[23], lm[25], "#00ffcc", 10); drawL(lm[25], lm[27], "#00ffcc", 10);
    }
    if (!isSeeking) { seek.value = vd.currentTime; document.getElementById('t-cur').innerText = vd.currentTime.toFixed(2); }
    isProcessing = false;
  });

  // 2. è¿½å¾“ç²¾åº¦ï¼šã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã«å¸ã„ä»˜ãã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•
  async function syncPose() {
    if (!isProcessing) {
      isProcessing = true;
      await pose.send({image: vd});
    }
  }

  seek.oninput = () => {
    vd.currentTime = seek.value;
    document.getElementById('t-cur').innerText = parseFloat(seek.value).toFixed(2);
    syncPose(); // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‹•ã‹ã—ãŸç¬é–“ã«è§£æ
  };
  seek.onpointerdown = () => { isSeeking = true; vd.pause(); pBtn.innerText = "â–¶"; };
  seek.onpointerup = () => { isSeeking = false; };

  // 3. å†ç”Ÿãƒ«ãƒ¼ãƒ—
  async function renderLoop() {
    if (!vd.paused && !isSeeking) {
      await pose.send({image: vd});
      requestAnimationFrame(renderLoop);
    }
  }

  pBtn.onclick = () => {
    if (vd.paused) { vd.play(); pBtn.innerText = "â€–"; renderLoop(); }
    else { vd.pause(); pBtn.innerText = "â–¶"; }
  };

  function jump(d) { vd.pause(); pBtn.innerText = "â–¶"; vd.currentTime += d; syncPose(); }
  function toggleSlow() { vd.playbackRate = vd.playbackRate === 1.0 ? 0.25 : 1.0; document.getElementById('sl-btn').classList.toggle('active-mode', vd.playbackRate === 0.25); }

  document.getElementById('up').onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
      vd.src = URL.createObjectURL(file);
      vd.onloadedmetadata = () => { seek.max = vd.duration; document.getElementById('t-dur').innerText = vd.duration.toFixed(2); vd.play(); pBtn.innerText = "â€–"; renderLoop(); };
    }
  };
</script>
</body>
</html>
