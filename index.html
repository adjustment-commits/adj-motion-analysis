<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Kinetic Pro Precision</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <style>
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; color: #fff; font-family: sans-serif; }
    #layout { display: flex; flex-direction: column; width: 100vw; height: 100vh; }
    .header { height: 60px; background: #1a1a1a; display: flex; gap: 8px; padding: 0 10px; align-items: center; flex-shrink: 0; }
    .top-btn { flex: 1; height: 40px; background: #333; color: #fff; border: 1px solid #555; border-radius: 6px; font-size: 13px; display: flex; align-items: center; justify-content: center; }
    .main-view { flex: 1; position: relative; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; }
    canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
    .deck { height: 280px; background: #111; padding: 15px 20px; box-sizing: border-box; flex-shrink: 0; }
    
    /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å·¨å¤§åŒ–ãƒ»é«˜æ„Ÿåº¦åŒ– */
    .time-row { display: flex; justify-content: space-between; color: #00ffcc; font-family: monospace; font-size: 20px; margin-bottom: 10px; }
    input[type="range"] { width: 100%; height: 60px; accent-color: #00ffcc; margin: 10px 0; }

    .btn-row { display: flex; gap: 10px; height: 70px; }
    .f-btn { flex: 1; background: #2a2a2a; color: #fff; border: 1px solid #555; border-radius: 12px; font-weight: bold; font-size: 16px; -webkit-tap-highlight-color: transparent; }
    .f-btn:active { background: #444; }
    .play-btn { flex: 0.6; background: #00ffcc; color: #000; border: none; font-size: 24px; }
    
    .tags { position: absolute; top: 10px; left: 10px; pointer-events: none; }
    .badge { background: rgba(0,0,0,0.7); padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-bottom: 4px; border-left: 4px solid #00ffcc; }
    .b-arm { border-left-color: #ff3366; }
  </style>
</head>
<body>
<div id="layout">
  <div class="header">
    <label class="top-btn">ğŸ¥ å‹•ç”»ã‚’é¸æŠ<input type="file" id="up" accept="video/*" style="display:none"></label>
    <select id="md" class="top-btn"><option value="pitch">æŠ•çƒ</option><option value="bat">æ‰“æ’ƒ</option></select>
    <select id="vw" class="top-btn"><option value="both">å®Ÿå†™ï¼‹éª¨æ ¼</option><option value="stick">éª¨æ ¼ã®ã¿</option></select>
  </div>
  <div class="main-view">
    <canvas id="cv"></canvas>
    <div class="tags">
      <div id="r-txt" class="badge b-arm">å³è…•: --</div><div id="l-txt" class="badge b-arm">å·¦è…•: --</div>
      <div id="rk-txt" class="badge">å³è¶³: --</div><div id="lk-txt" class="badge">å·¦è¶³: --</div>
    </div>
  </div>
  <div class="deck">
    <div class="time-row"><span id="cn">0.00</span><span> / </span><span id="tn">0.00</span>s</div>
    <input type="range" id="sk" value="0" step="0.0001">
    <div class="btn-row">
      <button class="f-btn" onclick="jump(-0.033)">â—€ 1Fæˆ»ã‚‹</button>
      <button class="f-btn play-btn" id="pp">â–¶</button>
      <button class="f-btn" onclick="jump(0.033)">1Fé€ã‚‹ â–¶</button>
    </div>
    <div style="text-align:center; color:#888; font-size:12px; margin-top:15px;">â€»ä¿å­˜ã¯iPadã®ã€Œç”»é¢åéŒ²ã€ã‚’ã”åˆ©ç”¨ãã ã•ã„</div>
  </div>
</div>
<video id="vd" playsinline muted style="display:none"></video>

<script>
  const vd = document.getElementById('vd'), cv = document.getElementById('cv'), ctx = cv.getContext('2d'), sk = document.getElementById('sk'), pp = document.getElementById('pp');
  let seeking = false;

  const pose = new Pose({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
  pose.setOptions({modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});

  function getAngle(p1, p2, p3) {
    const a = Math.sqrt(Math.pow(p2.x-p3.x,2) + Math.pow(p2.y-p3.y,2));
    const b = Math.sqrt(Math.pow(p1.x-p3.x,2) + Math.pow(p1.y-p3.y,2));
    const c = Math.sqrt(Math.pow(p1.x-p2.x,2) + Math.pow(p1.y-p2.y,2));
    return Math.acos((Math.pow(a,2) + Math.pow(c,2) - Math.pow(b,2)) / (2*a*c)) * (180/Math.PI);
  }

  pose.onResults((r) => {
    cv.width = vd.videoWidth; cv.height = vd.videoHeight;
    ctx.clearRect(0, 0, cv.width, cv.height);
    if (document.getElementById('vw').value !== 'stick') ctx.drawImage(r.image, 0, 0, cv.width, cv.height);
    if (r.poseLandmarks) {
      const lm = r.poseLandmarks;
      const draw = (p1, p2, col) => {
        ctx.beginPath(); ctx.moveTo(p1.x * cv.width, p1.y * cv.height); ctx.lineTo(p2.x * cv.width, p2.y * cv.height);
        ctx.strokeStyle = col; ctx.lineWidth = 6; ctx.lineCap = "round"; ctx.stroke();
      };
      const isP = document.getElementById('md').value === 'pitch';
      
      const rA = isP ? (lm[16].x < lm[14].x + 0.05) : (lm[16].y > lm[14].y);
      const lA = isP ? (lm[15].x > lm[13].x - 0.05) : (lm[15].y > lm[13].y);
      draw(lm[12], lm[14], rA ? "#00e5ff" : "#ff3366"); draw(lm[14], lm[16], rA ? "#00e5ff" : "#ff3366");
      draw(lm[11], lm[13], lA ? "#00e5ff" : "#ff3366"); draw(lm[13], lm[15], lA ? "#00e5ff" : "#ff3366");
      document.getElementById('r-txt').innerText = `å³è…•: ${rA ? 'ä¼¸å¼µ' : 'åå°„'}`;
      document.getElementById('l-txt').innerText = `å·¦è…•: ${lA ? 'ä¼¸å¼µ' : 'åå°„'}`;

      const rK = getAngle(lm[24], lm[26], lm[28]), lK = getAngle(lm[23], lm[25], lm[27]);
      const rLE = rK < 160, lLE = lK < 160;
      draw(lm[24], lm[26], rLE ? "#00ffcc" : "#ff3366"); draw(lm[26], lm[28], rLE ? "#00ffcc" : "#ff3366");
      draw(lm[23], lm[25], lLE ? "#00ffcc" : "#ff3366"); draw(lm[25], lm[27], lLE ? "#00ffcc" : "#ff3366");
      document.getElementById('rk-txt').innerText = `å³è¶³: ${rLE ? 'ä¼¸å¼µ' : 'åå°„'}`;
      document.getElementById('lk-txt').innerText = `å·¦è¶³: ${lLE ? 'ä¼¸å¼µ' : 'åå°„'}`;
    }
  });

  async function render() {
    if (!vd.paused || seeking) {
      await pose.send({image: vd});
      if (!seeking) {
        sk.value = vd.currentTime;
        document.getElementById('cn').innerText = vd.currentTime.toFixed(2);
      }
    }
    requestAnimationFrame(render);
  }

  // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç²¾åº¦é‡è¦–ã®è¨­å®š
  sk.addEventListener('input', () => {
    seeking = true;
    vd.currentTime = sk.value;
    document.getElementById('cn').innerText = parseFloat(sk.value).toFixed(2);
  });
  sk.addEventListener('change', () => { seeking = false; });

  pp.onclick = () => { if (vd.paused) { vd.play(); pp.innerText = "â€–"; } else { vd.pause(); pp.innerText = "â–¶"; } };
  function jump(d) { seeking = true; vd.currentTime += d; setTimeout(()=>seeking=false, 100); }

  document.getElementById('up').onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
      vd.src = URL.createObjectURL(file);
      vd.onloadedmetadata = () => {
        sk.max = vd.duration;
        document.getElementById('tn').innerText = vd.duration.toFixed(2);
        render();
      };
    }
  };
</script>
</body>
</html>
