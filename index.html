<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Kinetic Analysis - Responsive Base</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <style>
    /* åœŸå°ã®è¨­å®šï¼šç”»é¢å…¨ä½“ã‚’100ã¨ã—ãŸæ¯”ç‡ã§ç®¡ç† */
    html, body { 
      margin: 0; padding: 0; width: 100%; height: 100%; 
      overflow: hidden; background: #000; font-family: sans-serif;
    }
    
    #app-container { 
      display: flex; flex-direction: column; 
      width: 100vw; height: 100vh; 
    }

    /* 1. ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šå¸¸ã«ä¸Šéƒ¨ã«å›ºå®š */
    .base-header { 
      height: 60px; background: #1a1a1a; flex-shrink: 0;
      display: flex; align-items: center; gap: 10px; padding: 0 15px;
    }
    select, .upload-label { 
      background: #333; color: #fff; border: 1px solid #555; 
      padding: 8px; border-radius: 6px; font-size: 13px; flex: 1; text-align: center;
    }

    /* 2. ãƒ¡ã‚¤ãƒ³ï¼šãƒ‡ãƒã‚¤ã‚¹ã®ä½™ã£ãŸã‚¹ãƒšãƒ¼ã‚¹ã‚’ã™ã¹ã¦ä½¿ã„ã€è‡ªå‹•ã§å¤§ãã•ãŒå¤‰ã‚ã‚‹ */
    .base-main { 
      flex: 1; min-height: 0; position: relative; 
      display: flex; justify-content: center; align-items: center;
    }
    canvas { max-width: 95%; max-height: 95%; object-fit: contain; }

    /* 3. æ“ä½œãƒ‡ãƒƒã‚­ï¼šç”»é¢ä¸‹éƒ¨ã‹ã‚‰ã€Œæµ®ã„ãŸã€ä½ç½®ã‚’ã‚­ãƒ¼ãƒ—ã™ã‚‹åœŸå° */
    .base-footer { 
      background: #111; border-top: 1px solid #333;
      padding: 20px 20px calc(env(safe-area-inset-bottom) + 50px) 20px; 
      flex-shrink: 0;
    }
    
    .control-panel { max-width: 800px; margin: 0 auto; } /* PCã‚„å¤§å‹ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ã‚‚åºƒãŒã‚Šã™ããªã„ */

    /* æ“ä½œãƒ‘ãƒ¼ãƒ„ */
    .slider-row { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
    .play-btn { 
      width: 60px; height: 60px; background: #00ffcc; color: #000; 
      border: none; border-radius: 50%; font-size: 24px; flex-shrink: 0;
    }
    input[type="range"] { flex: 1; height: 30px; accent-color: #00ffcc; }

    .btn-row { display: flex; gap: 10px; }
    .action-btn { 
      flex: 1; height: 50px; background: #2a2a2a; color: #fff; 
      border: 1px solid #444; border-radius: 10px; font-weight: bold;
    }
    .action-btn.active { background: #00ffcc; color: #000; }

    /* æƒ…å ±ãƒãƒƒã‚¸ */
    .badge-layer { position: absolute; top: 10px; left: 10px; pointer-events: none; }
    .badge { background: rgba(0,0,0,0.7); color: #fff; padding: 4px 8px; font-size: 11px; margin-bottom: 3px; border-left: 3px solid #00ffcc; }
  </style>
</head>
<body>

<div id="app-container">
  <div class="base-header">
    <label class="upload-label">ğŸ“¹ é¸æŠ<input type="file" id="upload" accept="video/*" style="display:none"></label>
    <select id="mode-select"><option value="pitch">æŠ•çƒãƒ¢ãƒ¼ãƒ‰</option><option value="bat">æ‰“æ’ƒãƒ¢ãƒ¼ãƒ‰</option></select>
    <select id="view-mode"><option value="both">å®Ÿå†™ï¼‹éª¨æ ¼</option><option value="stick">éª¨æ ¼ã®ã¿</option></select>
  </div>

  <div class="base-main">
    <canvas id="output_canvas"></canvas>
    <div class="badge-layer">
      <div id="badge-r" class="badge">å³è…•: --</div>
      <div id="badge-l" class="badge">å·¦è…•: --</div>
    </div>
  </div>

  <div class="base-footer">
    <div class="control-panel">
      <div class="slider-row">
        <button class="play-btn" id="play-btn">â–¶</button>
        <div style="flex:1">
          <div style="color:#00ffcc; font-size:12px; margin-bottom:4px">
            <span id="cur-time">0.00</span> / <span id="total-time">0.00</span>s
          </div>
          <input type="range" id="seek-bar" value="0" step="0.001">
        </div>
      </div>
      <div class="btn-row">
        <button class="action-btn" onclick="step(-1)">â—€ æˆ»ã™</button>
        <button class="action-btn" id="slow-btn" onclick="toggleSlow()">SLOW</button>
        <button class="action-btn" onclick="step(1)">é€ã‚‹ â–¶</button>
      </div>
    </div>
  </div>
</div>

<video id="v" playsinline muted style="display:none"></video>

<script>
  // å‰å›ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆè…•ã®è‰²åˆ†ã‘åˆ¤å®šã€é ­ã®ãƒ™ã‚¯ãƒˆãƒ«ã€çµ‚äº†å¾Œã®è¿½å¾“ï¼‰ã‚’å…¨ã¦é©ç”¨
  const v = document.getElementById('v'), canvas = document.getElementById('output_canvas'), ctx = canvas.getContext('2d');
  const seekBar = document.getElementById('seek-bar'), playBtn = document.getElementById('play-btn');
  let isSeeking = false;

  const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
  pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

  pose.onResults((r) => {
    if (!r.image) return;
    canvas.width = r.image.width; canvas.height = r.image.height;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (document.getElementById('view-mode').value !== 'stick') ctx.drawImage(r.image, 0, 0, canvas.width, canvas.height);
    
    if (r.poseLandmarks) {
      const lm = r.poseLandmarks;
      const draw = (p1, p2, col, w) => {
        ctx.beginPath(); ctx.moveTo(p1.x*canvas.width, p1.y*canvas.height);
        ctx.lineTo(p2.x*canvas.width, p2.y*canvas.height);
        ctx.strokeStyle = col; ctx.lineWidth = w; ctx.lineCap = "round"; ctx.stroke();
      };

      const nose = lm[0], ear = { x: (lm[7].x + lm[8].x)/2, y: (lm[7].y + lm[8].y)/2 };
      draw(nose, { x: nose.x + (nose.x - ear.x), y: nose.y + (nose.y - ear.y) }, "#ffff00", 4);

      const isP = document.getElementById('mode-select').value === 'pitch';
      const rExt = isP ? (lm[16].x < lm[14].x + 0.05) : (lm[16].y > lm[14].y);
      const rCol = rExt ? "#00e5ff" : "#ff3366";
      draw(lm[12], lm[14], rCol, 12); draw(lm[14], lm[16], rCol, 8);
      document.getElementById('badge-r').innerText = `å³è…•: ${rExt ? 'ã‚¿ãƒ¡' : 'è§£æ”¾'}`;
      document.getElementById('badge-r').style.borderColor = rCol;

      const lExt = isP ? (lm[15].x > lm[13].x - 0.05) : (lm[15].y > lm[13].y);
      const lCol = lExt ? "#00e5ff" : "#ff3366";
      draw(lm[11], lm[13], lCol, 12); draw(lm[13], lm[15], lCol, 8);
      document.getElementById('badge-l').innerText = `å·¦è…•: ${lExt ? 'ã‚¿ãƒ¡' : 'è§£æ”¾'}`;
      document.getElementById('badge-l').style.borderColor = lCol;

      draw(lm[24], lm[26], "#00ffcc", 10); draw(lm[26], lm[28], "#00ffcc", 10);
      draw(lm[23], lm[25], "#00ffcc", 10); draw(lm[25], lm[27], "#00ffcc", 10);
    }
    if (!isSeeking) { seekBar.value = v.currentTime; document.getElementById('cur-time').innerText = v.currentTime.toFixed(2); }
  });

  playBtn.onclick = () => { if (v.paused) { v.play(); playBtn.innerText = "â€–"; } else { v.pause(); playBtn.innerText = "â–¶"; } };
  seekBar.onpointerdown = () => { isSeeking = true; v.pause(); playBtn.innerText = "â–¶"; };
  seekBar.onpointerup = () => { isSeeking = false; };
  seekBar.oninput = () => { v.currentTime = seekBar.value; document.getElementById('cur-time').innerText = parseFloat(seekBar.value).toFixed(2); pose.send({image: v}); };
  
  function step(d) { v.pause(); playBtn.innerText = "â–¶"; v.currentTime += d * 0.033; pose.send({image: v}); }
  function toggleSlow() { v.playbackRate = v.playbackRate === 1.0 ? 0.25 : 1.0; document.getElementById('slow-btn').classList.toggle('active', v.playbackRate === 0.25); }

  document.getElementById('upload').onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
      v.src = URL.createObjectURL(file);
      v.onloadedmetadata = () => { seekBar.max = v.duration; document.getElementById('total-time').innerText = v.duration.toFixed(2); v.play(); playBtn.innerText = "â€–"; requestAnimationFrame(render); };
    }
  };
  async function render() { if (!v.paused || isSeeking) { await pose.send({image: v}); } requestAnimationFrame(render); }
</script>
</body>
</html>
