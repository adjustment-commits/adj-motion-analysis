<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Kinetic Linkage Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <style>
    /* iPadã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢è¨­å®š */
    :root { --safe-padding: 80px; } 
    html, body { margin: 0; padding: 0; width: 100%; height: 100dvh; overflow: hidden; background: #000; color: #fff; font-family: sans-serif; }
    #app-container { display: flex; flex-direction: column; width: 100%; height: 100dvh; }
    
    .display-area { flex: 1; position: relative; background: #000; display: flex; justify-content: center; align-items: center; }
    canvas { max-width: 100%; max-height: 100%; object-fit: contain; z-index: 2; }
    
    /* ä¸Šéƒ¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
    .data-overlay { position: absolute; top: 20px; left: 20px; pointer-events: none; z-index: 10; }
    .badge { background: rgba(0,0,0,0.8); padding: 10px 15px; border-left: 5px solid #00ffcc; font-size: 15px; margin-bottom: 5px; }

    /* ä¸‹éƒ¨æ“ä½œãƒ‘ãƒãƒ« */
    .ui-panel { background: #111; border-top: 1px solid #333; padding: 15px 25px var(--safe-padding); flex-shrink: 0; }
    .slider-row { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
    input[type="range"] { flex: 1; height: 44px; accent-color: #00ffcc; }
    .btn-row { display: flex; justify-content: space-around; gap: 10px; flex-wrap: wrap; }
    button, label, select { background: #2a2a2a; color: white; border: 1px solid #444; padding: 15px 10px; border-radius: 8px; font-size: 14px; font-weight: bold; flex: 1; text-align: center; }
  </style>
</head>
<body>

<div id="app-container">
  <div class="display-area">
    <canvas id="output_canvas"></canvas>
    <div class="data-overlay">
      <div id="mode-badge" class="badge">PITCHING MODE</div>
      <div id="trunk-badge" class="badge">èƒ¸éƒ­ãƒœãƒƒã‚¯ã‚¹: è§£æä¸­</div>
      <div id="arm-badge" class="badge">è…•: åˆ¤å®šä¸­</div>
    </div>
  </div>

  <div class="ui-panel">
    <div class="slider-row">
      <span id="time-val" style="min-width:60px;">0.00s</span>
      <input type="range" id="seek-bar" value="0" step="0.001">
    </div>
    <div class="btn-row">
      <label for="upload">ğŸ“¹ VIDEO<input type="file" id="upload" accept="video/*" style="display:none"></label>
      <select id="analysis-mode"><option value="pitch">æŠ•çƒè§£æ</option><option value="bat">æ‰“æ’ƒè§£æ</option></select>
      <select id="view-mode"><option value="both">å®Ÿå†™+éª¨æ ¼</option><option value="stick">éª¨æ ¼ã®ã¿</option></select>
      <button onclick="video.paused ? video.play() : video.pause()">â–·/||</button>
      <button onclick="video.playbackRate = (video.playbackRate === 0.25 ? 1.0 : 0.25)">SLOW</button>
    </div>
  </div>
</div>

<video id="input_video" playsinline muted style="display:none;"></video>

<script>
  const video = document.getElementById('input_video');
  const canvas = document.getElementById('output_canvas');
  const ctx = canvas.getContext('2d');
  const seekBar = document.getElementById('seek-bar');
  const timeVal = document.getElementById('time-val');
  const analysisMode = document.getElementById('analysis-mode');
  const viewMode = document.getElementById('view-mode');

  const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
  pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

  pose.onResults((results) => {
    if (!results.image) return;
    canvas.width = results.image.width;
    canvas.height = results.image.height;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (viewMode.value === 'stick') {
      ctx.fillStyle = "#000"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    } else {
      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
    }

    if (results.poseLandmarks) {
      const lm = results.poseLandmarks;
      const shL = lm[11], shR = lm[12], hipL = lm[23], hipR = lm[24];
      const elR = lm[14], wrR = lm[16], elL = lm[13], wrL = lm[15];
      const kneeR = lm[26], ankR = lm[28], kneeL = lm[25], ankL = lm[27];

      const drawL = (p1, p2, col, w, glow=false) => {
        ctx.beginPath();
        if(glow) { ctx.shadowBlur = 10; ctx.shadowColor = col; }
        ctx.moveTo(p1.x*canvas.width, p1.y*canvas.height); ctx.lineTo(p2.x*canvas.width, p2.y*canvas.height);
        ctx.strokeStyle = col; ctx.lineWidth = w; ctx.lineCap = "round"; ctx.stroke(); ctx.shadowBlur = 0;
      };

      // 1. èƒ¸éƒ­ãƒœãƒƒã‚¯ã‚¹
      ctx.beginPath();
      ctx.moveTo(shL.x*canvas.width, shL.y*canvas.height); ctx.lineTo(shR.x*canvas.width, shR.y*canvas.height);
      ctx.lineTo(hipR.x*canvas.width, hipR.y*canvas.height); ctx.lineTo(hipL.x*canvas.width, hipL.y*canvas.height);
      ctx.closePath();
      ctx.fillStyle = "rgba(255,255,255,0.2)"; ctx.fill();
      ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; ctx.stroke();

      // 2. ãƒ‘ãƒ¯ãƒ¼ãƒ„ãƒªãƒ¼é€£å‹•ï¼ˆè»¸è¶³ã‹ã‚‰æŠ•çƒè‚©ï¼‰
      drawL(ankR, kneeR, "#00ffcc", 10, true); drawL(kneeR, hipR, "#00ffcc", 10, true);
      drawL(hipR, shR, "#ffffff", 4);

      // 3. æ”¹è‰¯ç‰ˆ å†…å¤–æ—‹åˆ¤å®š (è…•ã¨ã—ãªã‚Šã®è§£æ)
      // æŠ•çƒè…•ï¼šè‚©ã¨è‚˜ã®ãƒ©ã‚¤ãƒ³ã«å¯¾ã—ã¦æ‰‹é¦–ãŒèƒŒä¸­å´ï¼ˆå¤–æ—‹ï¼‰ã‹å‰ï¼ˆå†…æ—‹ï¼‰ã‹
      const isPitchMode = analysisMode.value === 'pitch';
      const armCondition = isPitchMode ? (wrR.x < elR.x + 0.05) : (wrR.x < shR.x); 
      const armCol = armCondition ? "#00e5ff" : "#ff3366";
      drawL(shR, elR, armCol, 14); drawL(elR, wrR, armCol, 10);

      // ã‚°ãƒ©ãƒ–è…•
      const grabCol = (wrL.x < elL.x) ? "#ff3366" : "#00e5ff";
      drawL(shL, elL, grabCol, 10); drawL(elL, wrL, grabCol, 6);

      // è¶³ã®é€£å‹•
      drawL(hipL, kneeL, (kneeL.x > hipL.x ? "#00e5ff" : "#ff3366"), 12);
      drawL(kneeL, ankL, (ankL.x > kneeL.x ? "#00e5ff" : "#ff3366"), 10);

      // 4. è¡¨ç¤ºæ›´æ–°
      document.getElementById('mode-badge').innerText = isPitchMode ? "PITCHING MODE" : "BATTING MODE";
      document.getElementById('trunk-badge').innerText = `èƒ¸éƒ­: ${Math.abs(shR.x-shL.x) > 0.15 ? 'æ­£é¢' : 'åŠèº«'}`;
      document.getElementById('arm-badge').innerText = `è…•: ${armCondition ? 'å¤–æ—‹ï¼ˆã‚¿ãƒ¡ï¼‰' : 'å†…æ—‹ï¼ˆãƒªãƒªãƒ¼ã‚¹ï¼‰'}`;
      document.getElementById('arm-badge').style.borderLeftColor = armCol;
    }
  });

  // UIåˆ¶å¾¡
  seekBar.oninput = () => { video.pause(); video.currentTime = seekBar.value; };
  document.getElementById('upload').onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
      video.src = URL.createObjectURL(file);
      video.onloadedmetadata = () => { seekBar.max = video.duration; video.play(); render(); };
    }
  };
  async function render() {
    if (!video.paused || video.currentTime >= 0) {
      await pose.send({image: video});
      seekBar.value = video.currentTime;
      timeVal.innerText = video.currentTime.toFixed(2) + "s";
    }
    requestAnimationFrame(render);
  }
</script>
</body>
</html>
