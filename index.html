<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Stable Coach Linkage</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
  <style>
    /* ç”»é¢å…¨ä½“ã‚’å›ºå®šï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ï¼‰ */
    html, body { 
      margin: 0; padding: 0; width: 100%; height: 100%; 
      overflow: hidden; background: #000; position: fixed; 
    }
    
    #app-container { 
      position: relative; width: 100vw; height: 100vh; 
      display: flex; flex-direction: column; 
    }

    /* æç”»ã‚¨ãƒªã‚¢ï¼šãƒœã‚¿ãƒ³ã®é«˜ã•ã‚’å¼•ã„ãŸåˆ†ã ã‘ç¢ºä¿ */
    .display-area { 
      flex: 1; width: 100%; background: #000; 
      display: flex; justify-content: center; align-items: center; 
    }
    canvas { max-width: 100%; max-height: 100%; object-fit: contain; }

    /* ä¸‹éƒ¨æ“ä½œãƒ‘ãƒãƒ«ï¼šä½ç½®ã‚’å®Œå…¨ã«å›ºå®š */
    .ui-panel { 
      height: 220px; /* é«˜ã•ã‚’å›ºå®š */
      background: #111; border-top: 1px solid #333; 
      padding: 10px 20px 40px 20px; /* iPadãƒ›ãƒ¼ãƒ ãƒãƒ¼ã®äºˆå‚™ä½™ç™½ */
      box-sizing: border-box;
    }

    .slider-row { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
    input[type="range"] { flex: 1; height: 44px; accent-color: #00ffcc; }
    #time-display { font-family: monospace; font-size: 18px; color: #00ffcc; min-width: 60px; }

    .btn-row { display: flex; gap: 10px; height: 60px; }
    button, label, select { 
      background: #252525; color: white; border: 1px solid #444; 
      border-radius: 10px; font-size: 14px; font-weight: bold; 
      flex: 1; display: flex; justify-content: center; align-items: center;
      -webkit-appearance: none;
    }
    button:active, label:active { background: #444; }
  </style>
</head>
<body>

<div id="app-container">
  <div class="display-area">
    <canvas id="output_canvas"></canvas>
  </div>

  <div class="ui-panel">
    <div class="slider-row">
      <span id="time-display">0.00s</span>
      <input type="range" id="seek-bar" value="0" step="0.001">
    </div>
    <div class="btn-row">
      <label for="upload">ğŸ“¹å‹•ç”»<input type="file" id="upload" accept="video/*" style="display:none"></label>
      <select id="view-mode">
        <option value="both">å®Ÿå†™ï¼‹éª¨æ ¼</option>
        <option value="stick">éª¨æ ¼ã®ã¿</option>
      </select>
      <button onclick="video.paused ? video.play() : video.pause()">â–·/||</button>
      <button id="slow-btn" onclick="toggleSlow()">SLOW</button>
    </div>
  </div>
</div>

<video id="input_video" playsinline muted style="display:none;"></video>

<script>
  const video = document.getElementById('input_video');
  const canvas = document.getElementById('output_canvas');
  const ctx = canvas.getContext('2d');
  const seekBar = document.getElementById('seek-bar');
  const viewMode = document.getElementById('view-mode');

  const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
  pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });

  pose.onResults((results) => {
    if (!results.image) return;
    canvas.width = results.image.width;
    canvas.height = results.image.height;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (viewMode.value !== 'stick') {
      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
    } else {
      ctx.fillStyle = "#000"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    if (results.poseLandmarks) {
      const lm = results.poseLandmarks;
      const draw = (p1, p2, col, w, glow=false) => {
        ctx.beginPath();
        if(glow){ ctx.shadowBlur=10; ctx.shadowColor=col; }
        ctx.moveTo(p1.x*canvas.width, p1.y*canvas.height);
        ctx.lineTo(p2.x*canvas.width, p2.y*canvas.height);
        ctx.strokeStyle = col; ctx.lineWidth = w; ctx.lineCap = "round"; ctx.stroke();
        ctx.shadowBlur=0;
      };

      // 1. èƒ¸éƒ­ãƒœãƒƒã‚¯ã‚¹
      ctx.beginPath();
      ctx.moveTo(lm[11].x*canvas.width, lm[11].y*canvas.height);
      ctx.lineTo(lm[12].x*canvas.width, lm[12].y*canvas.height);
      ctx.lineTo(lm[24].x*canvas.width, lm[24].y*canvas.height);
      ctx.lineTo(lm[23].x*canvas.width, lm[23].y*canvas.height);
      ctx.closePath();
      ctx.fillStyle = "rgba(255,255,255,0.15)"; ctx.fill();
      ctx.strokeStyle = "#fff"; ctx.lineWidth = 1; ctx.stroke();

      // 2. ãƒ‘ãƒ¯ãƒ¼ãƒ„ãƒªãƒ¼ï¼ˆè»¸è¶³ã‹ã‚‰æŠ•çƒè‚©ï¼‰
      draw(lm[28], lm[26], "#00ffcc", 10, true); // è¶³é¦–-è†
      draw(lm[26], lm[24], "#00ffcc", 10, true); // è†-è‚¡é–¢ç¯€
      draw(lm[24], lm[12], "#ffffff", 1.5);      // è»¸ã‹ã‚‰æŠ•çƒè‚©ã¸ã®ä¸€æœ¬ç·š

      // 3. æŠ•çƒè…•ï¼šã—ãªã‚Šã®è‰²ï¼ˆå¤–æ—‹=é’ / å†…æ—‹=èµ¤ï¼‰
      // è‚˜ã‚ˆã‚Šæ‰‹é¦–ãŒèƒŒä¸­å´ï¼ˆxåº§æ¨™ãŒå°ã•ã„ â€»å³æŠ•ã’æƒ³å®šï¼‰ãªã‚‰é’
      const isExternal = lm[16].x < lm[14].x + 0.05;
      const rArmCol = isExternal ? "#00e5ff" : "#ff3366";
      draw(lm[12], lm[14], rArmCol, 12); draw(lm[14], lm[16], rArmCol, 8);

      // ã‚°ãƒ©ãƒ–è…•ãƒ»è„š
      draw(lm[11], lm[13], "#888", 6); draw(lm[13], lm[15], "#888", 4);
      draw(lm[23], lm[25], "#00e5ff", 10); draw(lm[25], lm[27], "#00e5ff", 8);
    }
  });

  function toggleSlow() {
    video.playbackRate = video.playbackRate === 1.0 ? 0.25 : 1.0;
    const btn = document.getElementById('slow-btn');
    btn.style.background = video.playbackRate === 0.25 ? "#00ffcc" : "#252525";
    btn.style.color = video.playbackRate === 0.25 ? "#000" : "#fff";
  }

  seekBar.oninput = () => { video.pause(); video.currentTime = seekBar.value; };
  document.getElementById('upload').onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
      video.src = URL.createObjectURL(file);
      video.onloadedmetadata = () => { 
        seekBar.max = video.duration; 
        video.play(); 
        requestAnimationFrame(render); 
      };
    }
  };

  async function render() {
    if (!video.paused || video.currentTime >= 0) {
      await pose.send({image: video});
      seekBar.value = video.currentTime;
      document.getElementById('time-display').innerText = video.currentTime.toFixed(2) + "s";
    }
    requestAnimationFrame(render);
  }
</script>
</body>
</html>
